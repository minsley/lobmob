#!/bin/bash
# git-credential-lobwife — Git credential helper for lobwife token broker.
# Fetches repo-scoped GitHub tokens from lobwife on every git operation.
# Configure: git config --global credential.helper lobwife
set -euo pipefail

case "${1:-}" in
  get)
    TASK_ID="${TASK_ID:-}"
    LOBWIFE_URL="${LOBWIFE_URL:-}"

    if [[ -z "$TASK_ID" || -z "$LOBWIFE_URL" ]]; then
      exit 1
    fi

    RESPONSE=$(curl -sf -X POST "${LOBWIFE_URL}/api/token" \
      -H "Content-Type: application/json" \
      -d "{\"task_id\": \"${TASK_ID}\"}" 2>/dev/null) || exit 1

    TOKEN=$(echo "$RESPONSE" | python3 -c \
      "import sys,json; print(json.load(sys.stdin)['token'])" 2>/dev/null) || exit 1

    if [[ -z "$TOKEN" ]]; then exit 1; fi

    echo "protocol=https"
    echo "host=github.com"
    echo "username=x-access-token"
    echo "password=${TOKEN}"
    ;;
  store|erase)
    # No-op — tokens are ephemeral, never cached
    ;;
esac
