#!/bin/bash
# lobmob — CLI for managing the OpenClaw swarm
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
INFRA_DIR="$PROJECT_DIR/infra"
SECRETS_FILE="$PROJECT_DIR/secrets.env"
LOBMOB_SSH_KEY="$HOME/.ssh/lobmob_ed25519"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log()  { echo -e "${GREEN}[lobmob]${NC} $*"; }
warn() { echo -e "${YELLOW}[lobmob]${NC} $*"; }
err()  { echo -e "${RED}[lobmob]${NC} $*" >&2; }

usage() {
  cat <<EOF
Usage: lobmob <command> [options]

Infrastructure:
  bootstrap           Interactive wizard — full setup from scratch
  init                Generate WireGuard keys and prepare config files
  deploy              Deploy lobboss via Terraform + provision secrets via SSH
  provision-secrets   Re-push secrets to lobboss (e.g. after key rotation)
  destroy             Tear down all infrastructure

Fleet Management:
  spawn [id]          Spawn a new lobster (SSH into lobboss to run)
  teardown <id>       Destroy a specific lobster
  teardown-all        Destroy all lobster droplets
  status              Show fleet status (droplets, WG peers, open PRs)
  cleanup [hours]     Destroy lobsters older than N hours (default: 2)

Vault:
  vault-init          Initialize the Obsidian vault GitHub repo
  vault-sync          Pull latest vault to local machine

SSH:
  ssh-lobboss         SSH into the lobboss droplet
  ssh-lobster <id>    SSH into a lobster via lobboss (WG tunnel)

Power:
  sleep               Cull all lobsters then power off lobboss
  wake                Power on lobboss and wait for it to come back

Utilities:
  logs                Tail lobboss cloud-init logs
  prs                 List open PRs on the vault repo
EOF
}

# --- Helpers ---

load_secrets() {
  if [ ! -f "$SECRETS_FILE" ]; then
    err "secrets.env not found at $SECRETS_FILE"
    err "Copy secrets.env.example to secrets.env and fill in values"
    exit 1
  fi
  # Source secrets (handles lines with = in values)
  set -a
  source "$SECRETS_FILE"
  set +a
  # Export for Terraform provider
  export DIGITALOCEAN_TOKEN="$DO_TOKEN"
}

lobmob_ssh() {
  ssh -i "$LOBMOB_SSH_KEY" -o StrictHostKeyChecking=accept-new "$@"
}

ensure_ssh_key() {
  if [ ! -f "$LOBMOB_SSH_KEY" ]; then
    log "Generating lobmob SSH keypair at $LOBMOB_SSH_KEY..."
    ssh-keygen -t ed25519 -C "lobmob" -f "$LOBMOB_SSH_KEY" -N "" -q
    echo -e "  ${GREEN}✓${NC} Keypair generated"
  fi
}

get_lobboss_ip() {
  cd "$INFRA_DIR" && terraform output -raw lobboss_ip 2>/dev/null
}

get_lobboss_id() {
  local PROJECT_NAME
  PROJECT_NAME=$(grep project_name "$INFRA_DIR/terraform.tfvars" 2>/dev/null | cut -d'"' -f2)
  PROJECT_NAME="${PROJECT_NAME:-lobmob}"
  doctl compute droplet list \
    --tag-name "${PROJECT_NAME}-lobboss" \
    --format ID --no-header \
    --access-token "$DO_TOKEN" 2>/dev/null | head -1
}

wait_for_ssh() {
  local HOST="$1"
  local MAX_ATTEMPTS="${2:-30}"
  log "Waiting for SSH on $HOST..."
  for i in $(seq 1 "$MAX_ATTEMPTS"); do
    if lobmob_ssh -o ConnectTimeout=5 -o BatchMode=yes \
      "root@$HOST" "true" 2>/dev/null; then
      log "SSH: connected"
      return 0
    fi
    echo -n "."
    sleep 10
  done
  echo ""
  err "SSH connection to $HOST timed out after $((MAX_ATTEMPTS * 10))s"
  return 1
}

wait_for_cloud_init() {
  local HOST="$1"
  local MAX_ATTEMPTS="${2:-60}"
  log "Waiting for cloud-init to complete on $HOST..."
  for i in $(seq 1 "$MAX_ATTEMPTS"); do
    if lobmob_ssh -o ConnectTimeout=5 "root@$HOST" \
      "test -f /etc/lobmob/.cloud-init-done" 2>/dev/null; then
      log "Cloud-init: complete"
      return 0
    fi
    echo -n "."
    sleep 10
  done
  echo ""
  err "Cloud-init did not complete within $((MAX_ATTEMPTS * 10))s"
  err "Check: ssh root@$HOST tail -50 /var/log/cloud-init-output.log"
  return 1
}

# --- Commands ---

cmd_bootstrap() {
  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║        lobmob bootstrap wizard           ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════╝${NC}"
  echo ""

  # ── Step 1: Preflight checks ──────────────────────────────────────────
  log "Step 1/12 — Checking prerequisites"
  echo ""

  # Map CLI binary names to package names per package manager
  _pkg_name() {
    local tool="$1" mgr="$2"
    case "$tool" in
      wg)
        case "$mgr" in
          brew) echo "wireguard-tools" ;;
          apt)  echo "wireguard-tools" ;;
          dnf)  echo "wireguard-tools" ;;
        esac ;;
      terraform)
        case "$mgr" in
          brew) echo "hashicorp/tap/terraform" ;;
          *)    echo "terraform" ;;
        esac ;;
      gh)
        case "$mgr" in
          brew) echo "gh" ;;
          apt)  echo "gh" ;;
          dnf)  echo "gh" ;;
        esac ;;
      *) echo "$tool" ;;
    esac
  }

  # Detect package manager
  local PKG_MGR=""
  if command -v brew > /dev/null 2>&1; then
    PKG_MGR="brew"
  elif command -v apt-get > /dev/null 2>&1; then
    PKG_MGR="apt"
  elif command -v dnf > /dev/null 2>&1; then
    PKG_MGR="dnf"
  fi

  local MISSING_REQUIRED=()
  local MISSING_OPTIONAL=()

  for tool in terraform gh wg ssh jq; do
    if command -v "$tool" > /dev/null 2>&1; then
      echo -e "  ${GREEN}✓${NC} $tool"
    else
      echo -e "  ${RED}✗${NC} $tool — required"
      MISSING_REQUIRED+=("$tool")
    fi
  done
  if command -v doctl > /dev/null 2>&1; then
    echo -e "  ${GREEN}✓${NC} doctl"
  else
    echo -e "  ${YELLOW}?${NC} doctl — recommended (sleep/wake commands need it)"
    MISSING_OPTIONAL+=("doctl")
  fi

  # Offer to install missing tools
  if [ ${#MISSING_REQUIRED[@]} -gt 0 ] || [ ${#MISSING_OPTIONAL[@]} -gt 0 ]; then
    echo ""
    local ALL_MISSING=("${MISSING_REQUIRED[@]}" "${MISSING_OPTIONAL[@]}")

    if [ -z "$PKG_MGR" ]; then
      err "No supported package manager found (brew, apt, dnf)"
      err "Install manually: ${ALL_MISSING[*]}"
      if [ ${#MISSING_REQUIRED[@]} -gt 0 ]; then exit 1; fi
    else
      # Build install list with package names
      local INSTALL_PKGS=()
      for tool in "${ALL_MISSING[@]}"; do
        INSTALL_PKGS+=("$(_pkg_name "$tool" "$PKG_MGR")")
      done

      log "Missing: ${ALL_MISSING[*]}"
      read -rp "  Install via $PKG_MGR? [Y/n]: " BS_INSTALL
      BS_INSTALL="${BS_INSTALL:-Y}"

      if [[ "$BS_INSTALL" =~ ^[Yy]$ ]]; then
        case "$PKG_MGR" in
          brew)
            # Ensure HashiCorp tap if terraform is needed
            for tool in "${ALL_MISSING[@]}"; do
              if [ "$tool" = "terraform" ]; then
                brew tap hashicorp/tap 2>/dev/null || true
                break
              fi
            done
            # gh needs its own tap on some setups
            brew install "${INSTALL_PKGS[@]}"
            ;;
          apt)
            # Add external repos for tools not in default apt
            for tool in "${ALL_MISSING[@]}"; do
              case "$tool" in
                terraform)
                  log "  Adding HashiCorp APT repo..."
                  curl -fsSL https://apt.releases.hashicorp.com/gpg \
                    | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg 2>/dev/null
                  echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
                    | sudo tee /etc/apt/sources.list.d/hashicorp.list > /dev/null
                  ;;
                gh)
                  log "  Adding GitHub CLI APT repo..."
                  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
                    | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
                  echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
                    | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                  ;;
                doctl)
                  log "  Installing doctl from GitHub release..."
                  curl -sL https://github.com/digitalocean/doctl/releases/latest/download/doctl-1.104.0-linux-amd64.tar.gz \
                    | sudo tar -xzv -C /usr/local/bin
                  ;;
              esac
            done
            sudo apt-get update -qq
            # Filter out doctl (installed via binary above)
            local APT_PKGS=()
            for tool in "${ALL_MISSING[@]}"; do
              if [ "$tool" != "doctl" ]; then
                APT_PKGS+=("$(_pkg_name "$tool" apt)")
              fi
            done
            if [ ${#APT_PKGS[@]} -gt 0 ]; then
              sudo apt-get install -y "${APT_PKGS[@]}"
            fi
            ;;
          dnf)
            sudo dnf install -y "${INSTALL_PKGS[@]}"
            ;;
        esac

        # Re-check
        echo ""
        local STILL_MISSING=0
        for tool in "${MISSING_REQUIRED[@]}"; do
          if ! command -v "$tool" > /dev/null 2>&1; then
            echo -e "  ${RED}✗${NC} $tool — still not found"
            STILL_MISSING=1
          else
            echo -e "  ${GREEN}✓${NC} $tool — installed"
          fi
        done
        if [ "$STILL_MISSING" -eq 1 ]; then
          err "Some required tools could not be installed"
          exit 1
        fi
      else
        if [ ${#MISSING_REQUIRED[@]} -gt 0 ]; then
          err "Required tools missing: ${MISSING_REQUIRED[*]}"
          exit 1
        fi
      fi
    fi
  fi
  echo ""

  # ── Step 2: DigitalOcean ──────────────────────────────────────────────
  log "Step 2/12 — DigitalOcean"
  echo "  Create an API token at: https://cloud.digitalocean.com/account/api/tokens"
  echo "  Scopes: read + write"
  echo ""
  read -rsp "  DO API token: " BS_DO_TOKEN; echo ""

  if [ -z "$BS_DO_TOKEN" ]; then
    err "DO token is required"; exit 1
  fi

  log "  Validating token..."
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -H "Authorization: Bearer $BS_DO_TOKEN" \
    "https://api.digitalocean.com/v2/account")
  if [ "$HTTP_CODE" != "200" ]; then
    err "DO token validation failed (HTTP $HTTP_CODE). Check token and try again."
    exit 1
  fi
  echo -e "  ${GREEN}✓${NC} Token valid"
  echo ""

  echo "  Choose a region (nyc1, nyc3, sfo3, ams3, lon1, fra1, sgp1, blr1, tor1, syd1)"
  read -rp "  Region [nyc3]: " BS_REGION
  BS_REGION="${BS_REGION:-nyc3}"
  echo ""

  # ── Step 3: GitHub ────────────────────────────────────────────────────
  log "Step 3/12 — GitHub"
  echo ""
  read -rp "  Vault repo (org/name) [lobmob-vault]: " BS_VAULT_REPO
  BS_VAULT_REPO="${BS_VAULT_REPO:-lobmob-vault}"
  echo ""

  read -rp "  Create this repo now via GitHub CLI? [Y/n]: " BS_CREATE_REPO
  BS_CREATE_REPO="${BS_CREATE_REPO:-Y}"
  if [[ "$BS_CREATE_REPO" =~ ^[Yy]$ ]]; then
    log "  Creating repo..."
    gh repo create "$BS_VAULT_REPO" --private --description "lobmob swarm Obsidian vault" 2>/dev/null \
      && echo -e "  ${GREEN}✓${NC} Repo created" \
      || echo -e "  ${YELLOW}!${NC} Repo may already exist — continuing"

    # Seed the vault
    BS_TMPDIR=$(mktemp -d)
    gh repo clone "$BS_VAULT_REPO" "$BS_TMPDIR" 2>/dev/null || true
    if [ -d "$BS_TMPDIR/.git" ]; then
      cp -r "$PROJECT_DIR/vault-seed/"* "$BS_TMPDIR/" 2>/dev/null || true
      cp -r "$PROJECT_DIR/vault-seed/".obsidian "$BS_TMPDIR/" 2>/dev/null || true
      cp -r "$PROJECT_DIR/vault-seed/".gitattributes "$BS_TMPDIR/" 2>/dev/null || true
      cd "$BS_TMPDIR"
      git add -A
      git commit -m "Seed vault structure" 2>/dev/null || true
      mkdir -p 040-fleet/lobboss-skills 040-fleet/lobster-skills
      cp -r "$PROJECT_DIR/skills/lobboss/"* 040-fleet/lobboss-skills/ 2>/dev/null || true
      cp -r "$PROJECT_DIR/skills/lobster/"* 040-fleet/lobster-skills/ 2>/dev/null || true
      git add -A
      git commit -m "Add OpenClaw skills for fleet distribution" 2>/dev/null || true
      git push origin main 2>/dev/null || git push -u origin main 2>/dev/null || true
      echo -e "  ${GREEN}✓${NC} Vault seeded"
      rm -rf "$BS_TMPDIR"
      cd "$PROJECT_DIR"
    fi
    echo ""
  fi

  echo "  Create a fine-grained PAT at: https://github.com/settings/personal-access-tokens/new"
  echo "  Scope to the vault repo. Permissions: Contents (rw), Pull requests (rw), Metadata (r)"
  echo ""
  read -rsp "  GitHub PAT: " BS_GH_TOKEN; echo ""
  if [ -z "$BS_GH_TOKEN" ]; then
    err "GitHub token is required"; exit 1
  fi
  echo ""

  # Deploy key
  echo "  The vault repo needs an SSH deploy key for server-side git operations."
  read -rp "  Auto-generate a deploy key? [Y/n]: " BS_GEN_DEPLOY_KEY
  BS_GEN_DEPLOY_KEY="${BS_GEN_DEPLOY_KEY:-Y}"

  if [[ "$BS_GEN_DEPLOY_KEY" =~ ^[Yy]$ ]]; then
    BS_DEPLOY_TMPDIR=$(mktemp -d)
    ssh-keygen -t ed25519 -C "lobmob-deploy" -f "$BS_DEPLOY_TMPDIR/lobmob_deploy" -N "" -q
    BS_DEPLOY_KEY_B64=$(base64 < "$BS_DEPLOY_TMPDIR/lobmob_deploy" | tr -d '\n')
    BS_DEPLOY_PUBKEY=$(cat "$BS_DEPLOY_TMPDIR/lobmob_deploy.pub")
    rm -rf "$BS_DEPLOY_TMPDIR"

    echo ""
    echo -e "  ${YELLOW}ACTION REQUIRED:${NC} Add this public key as a deploy key on your vault repo"
    echo "  https://github.com/${BS_VAULT_REPO}/settings/keys"
    echo "  Enable \"Allow write access\""
    echo ""
    echo "  Public key:"
    echo -e "  ${CYAN}${BS_DEPLOY_PUBKEY}${NC}"
    echo ""
    read -rp "  Press Enter once you've added the deploy key..." _
  else
    echo "  Generate one with: ssh-keygen -t ed25519 -C lobmob-deploy -f ~/.ssh/lobmob_deploy -N \"\""
    echo "  Then base64-encode the private key: base64 < ~/.ssh/lobmob_deploy"
    echo ""
    read -rsp "  Paste base64-encoded deploy key: " BS_DEPLOY_KEY_B64; echo ""
    if [ -z "$BS_DEPLOY_KEY_B64" ]; then
      err "Deploy key is required"; exit 1
    fi
  fi
  echo ""

  # ── Step 4: Discord ──────────────────────────────────────────────────
  log "Step 4/12 — Discord"
  echo "  Create a bot at: https://discord.com/developers/applications"
  echo "  Enable MESSAGE CONTENT intent. Invite bot to your server."
  echo "  Create channels: #task-queue, #swarm-control, #results, #swarm-logs"
  echo ""
  read -rsp "  Discord bot token: " BS_DISCORD_TOKEN; echo ""
  if [ -z "$BS_DISCORD_TOKEN" ]; then
    err "Discord token is required"; exit 1
  fi
  echo ""

  # ── Step 5: Anthropic ────────────────────────────────────────────────
  log "Step 5/12 — Anthropic"
  echo "  Get an API key at: https://console.anthropic.com/settings/keys"
  echo ""
  read -rsp "  Anthropic API key: " BS_ANTHROPIC_KEY; echo ""
  if [ -z "$BS_ANTHROPIC_KEY" ]; then
    err "Anthropic API key is required"; exit 1
  fi
  echo ""

  # ── Step 6: SSH key ──────────────────────────────────────────────────
  log "Step 6/12 — SSH key"
  echo "  lobmob uses a dedicated keypair at $LOBMOB_SSH_KEY"
  if [ -f "$LOBMOB_SSH_KEY" ]; then
    echo -e "  ${GREEN}✓${NC} Key already exists"
  else
    ssh-keygen -t ed25519 -C "lobmob" -f "$LOBMOB_SSH_KEY" -N "" -q
    echo -e "  ${GREEN}✓${NC} Keypair generated"
  fi
  BS_SSH_PUB="${LOBMOB_SSH_KEY}.pub"
  echo ""

  # ── Step 7: Optional overrides ───────────────────────────────────────
  log "Step 7/12 — Droplet sizing"
  echo "  Defaults: lobboss s-2vcpu-4gb (\$24/mo), lobster s-1vcpu-2gb (\$12/mo)"
  read -rp "  Customize sizes? [y/N]: " BS_CUSTOM_SIZES
  BS_CUSTOM_SIZES="${BS_CUSTOM_SIZES:-N}"

  BS_MANAGER_SIZE=""
  BS_WORKER_SIZE=""
  if [[ "$BS_CUSTOM_SIZES" =~ ^[Yy]$ ]]; then
    read -rp "  Lobboss size [s-2vcpu-4gb]: " BS_MANAGER_SIZE
    BS_MANAGER_SIZE="${BS_MANAGER_SIZE:-s-2vcpu-4gb}"
    read -rp "  Lobster size [s-1vcpu-2gb]: " BS_WORKER_SIZE
    BS_WORKER_SIZE="${BS_WORKER_SIZE:-s-1vcpu-2gb}"
  fi
  echo ""

  # ── Step 8: WireGuard keys ──────────────────────────────────────────
  log "Step 8/12 — Generating WireGuard keys"
  BS_WG_PRIVKEY=$(wg genkey)
  BS_WG_PUBKEY=$(echo "$BS_WG_PRIVKEY" | wg pubkey)
  echo -e "  ${GREEN}✓${NC} Keypair generated"
  echo ""

  # ── Step 9: Write config files ──────────────────────────────────────
  log "Step 9/12 — Writing config files"

  # Check for existing files
  if [ -f "$SECRETS_FILE" ]; then
    warn "  secrets.env already exists"
    read -rp "  Overwrite? [y/N]: " BS_OVERWRITE_SECRETS
    if [[ ! "$BS_OVERWRITE_SECRETS" =~ ^[Yy]$ ]]; then
      log "  Keeping existing secrets.env"
      BS_SKIP_SECRETS=1
    fi
  fi

  if [ -z "${BS_SKIP_SECRETS:-}" ]; then
    cat > "$SECRETS_FILE" <<SECRETSEOF
DO_TOKEN=$BS_DO_TOKEN
GH_TOKEN=$BS_GH_TOKEN
DISCORD_BOT_TOKEN=$BS_DISCORD_TOKEN
ANTHROPIC_API_KEY=$BS_ANTHROPIC_KEY
VAULT_DEPLOY_KEY_B64=$BS_DEPLOY_KEY_B64
WG_LOBBOSS_PRIVATE_KEY=$BS_WG_PRIVKEY
SECRETSEOF
    chmod 600 "$SECRETS_FILE"
    echo -e "  ${GREEN}✓${NC} secrets.env written"
  fi

  if [ -f "$INFRA_DIR/terraform.tfvars" ]; then
    warn "  terraform.tfvars already exists"
    read -rp "  Overwrite? [y/N]: " BS_OVERWRITE_TFVARS
    if [[ ! "$BS_OVERWRITE_TFVARS" =~ ^[Yy]$ ]]; then
      log "  Keeping existing terraform.tfvars"
      BS_SKIP_TFVARS=1
    fi
  fi

  if [ -z "${BS_SKIP_TFVARS:-}" ]; then
    {
      echo "vault_repo            = \"$BS_VAULT_REPO\""
      echo "wg_lobboss_public_key = \"$BS_WG_PUBKEY\""
      echo "ssh_pub_key_path      = \"$BS_SSH_PUB\""
      echo "region                = \"$BS_REGION\""
      echo "project_name          = \"lobmob\""
      if [ -n "$BS_MANAGER_SIZE" ]; then
        echo "manager_size          = \"$BS_MANAGER_SIZE\""
      fi
      if [ -n "$BS_WORKER_SIZE" ]; then
        echo "worker_size           = \"$BS_WORKER_SIZE\""
      fi
    } > "$INFRA_DIR/terraform.tfvars"
    echo -e "  ${GREEN}✓${NC} terraform.tfvars written"
  fi
  echo ""

  # ── Step 10: Terraform init + plan ──────────────────────────────────
  log "Step 10/12 — Terraform init"
  export DIGITALOCEAN_TOKEN="$BS_DO_TOKEN"
  cd "$INFRA_DIR" && terraform init
  echo ""

  log "Step 11/12 — Terraform plan"
  terraform plan -out=tfplan
  echo ""

  read -rp "$(echo -e "${YELLOW}Deploy now?${NC} [Y/n]: ")" BS_DEPLOY_NOW
  BS_DEPLOY_NOW="${BS_DEPLOY_NOW:-Y}"
  if [[ ! "$BS_DEPLOY_NOW" =~ ^[Yy]$ ]]; then
    log "Config saved. Run 'lobmob deploy' when ready."
    return
  fi

  # ── Step 11/12: Deploy ──────────────────────────────────────────────
  echo ""
  terraform apply tfplan
  LOBBOSS_IP=$(terraform output -raw lobboss_ip)
  log "Lobboss droplet created at $LOBBOSS_IP"

  wait_for_ssh "$LOBBOSS_IP"
  wait_for_cloud_init "$LOBBOSS_IP"

  # ── Step 12: Provision secrets ──────────────────────────────────────
  log "Step 12/12 — Provisioning secrets"

  # Source the written secrets for cmd_provision_secrets_to
  set -a; source "$SECRETS_FILE"; set +a
  export DIGITALOCEAN_TOKEN="$DO_TOKEN"

  cmd_provision_secrets_to "$LOBBOSS_IP"

  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║           lobmob is live!                ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════╝${NC}"
  echo ""
  log "Lobboss running at $LOBBOSS_IP"
  echo ""
  echo "  Next steps:"
  echo "    lobmob ssh-lobboss        SSH into lobboss"
  echo "    lobmob spawn              Spawn a lobster"
  echo "    lobmob status             Fleet status"
  echo "    lobmob sleep              Power down when done"
  echo ""
}

cmd_init() {
  ensure_ssh_key

  log "Generating WireGuard keypair for lobboss..."
  WG_PRIVKEY=$(wg genkey 2>/dev/null || { err "wg not found — install wireguard-tools"; exit 1; })
  WG_PUBKEY=$(echo "$WG_PRIVKEY" | wg pubkey)

  log "Public key: $WG_PUBKEY"

  # Create terraform.tfvars if missing
  if [ ! -f "$INFRA_DIR/terraform.tfvars" ]; then
    cp "$INFRA_DIR/terraform.tfvars.example" "$INFRA_DIR/terraform.tfvars"
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "s|wg_lobboss_public_key.*|wg_lobboss_public_key = \"$WG_PUBKEY\"|" "$INFRA_DIR/terraform.tfvars"
    else
      sed -i "s|wg_lobboss_public_key.*|wg_lobboss_public_key = \"$WG_PUBKEY\"|" "$INFRA_DIR/terraform.tfvars"
    fi
    log "Created infra/terraform.tfvars — fill in vault_repo"
  else
    warn "terraform.tfvars already exists — public key: $WG_PUBKEY"
  fi

  # Create secrets.env if missing
  if [ ! -f "$SECRETS_FILE" ]; then
    cp "$PROJECT_DIR/secrets.env.example" "$SECRETS_FILE"
    if [[ "$OSTYPE" == "darwin"* ]]; then
      sed -i '' "s|^WG_LOBBOSS_PRIVATE_KEY=.*|WG_LOBBOSS_PRIVATE_KEY=$WG_PRIVKEY|" "$SECRETS_FILE"
    else
      sed -i "s|^WG_LOBBOSS_PRIVATE_KEY=.*|WG_LOBBOSS_PRIVATE_KEY=$WG_PRIVKEY|" "$SECRETS_FILE"
    fi
    log "Created secrets.env — fill in your tokens"
    warn "The WG private key has been written to secrets.env"
    warn "NEVER commit secrets.env to git"
  else
    warn "secrets.env already exists — WG private key: (set WG_LOBBOSS_PRIVATE_KEY manually)"
    echo "  $WG_PRIVKEY"
  fi

  log "Initializing Terraform..."
  # Need DO token for terraform init if backend requires it
  if [ -f "$SECRETS_FILE" ]; then
    load_secrets 2>/dev/null || true
  fi
  cd "$INFRA_DIR" && terraform init
}

cmd_deploy() {
  load_secrets

  log "Deploying lobboss via Terraform..."
  cd "$INFRA_DIR"
  terraform plan -out=tfplan
  echo ""
  read -rp "Apply this plan? [y/N] " confirm
  if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    log "Cancelled"
    return
  fi

  terraform apply tfplan
  LOBBOSS_IP=$(terraform output -raw lobboss_ip)
  log "Lobboss droplet created at $LOBBOSS_IP"

  # Wait for SSH and cloud-init
  wait_for_ssh "$LOBBOSS_IP"
  wait_for_cloud_init "$LOBBOSS_IP"

  # Push secrets
  log "Provisioning secrets via SSH..."
  cmd_provision_secrets_to "$LOBBOSS_IP"

  log ""
  log "Lobboss fully deployed and provisioned at $LOBBOSS_IP"
  log "  SSH:    lobmob ssh-lobboss"
  log "  Status: lobmob status"
}

cmd_provision_secrets() {
  load_secrets
  LOBBOSS_IP=$(get_lobboss_ip)
  if [ -z "$LOBBOSS_IP" ]; then
    err "Lobboss not deployed. Run: lobmob deploy"
    exit 1
  fi
  cmd_provision_secrets_to "$LOBBOSS_IP"
}

cmd_provision_secrets_to() {
  local HOST="$1"
  load_secrets

  log "Pushing secrets to $HOST..."

  # 1. Push secrets.env (service tokens)
  lobmob_ssh "root@$HOST" "cat > /etc/lobmob/secrets.env && chmod 600 /etc/lobmob/secrets.env" <<EOF
DO_TOKEN=$DO_TOKEN
GH_TOKEN=$GH_TOKEN
DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY
EOF
  log "  secrets.env: pushed"

  # 2. Push vault deploy key
  echo "$VAULT_DEPLOY_KEY_B64" | base64 -d | \
    lobmob_ssh "root@$HOST" "cat > /root/.ssh/vault_key && chmod 600 /root/.ssh/vault_key"
  log "  deploy key: pushed"

  # 3. Push WireGuard private key into config
  lobmob_ssh "root@$HOST" bash <<WGSETUP
    if [ -f /etc/wireguard/wg0.conf.template ]; then
      sed "s|__WG_PRIVATE_KEY__|$WG_LOBBOSS_PRIVATE_KEY|" \
        /etc/wireguard/wg0.conf.template > /etc/wireguard/wg0.conf
      chmod 600 /etc/wireguard/wg0.conf
      rm /etc/wireguard/wg0.conf.template
    fi
WGSETUP
  log "  WireGuard key: pushed"

  # 4. Run the provision script on lobboss
  log "Running provision script..."
  lobmob_ssh "root@$HOST" "/usr/local/bin/lobmob-provision"

  log "Secrets provisioned successfully"
}

cmd_destroy() {
  warn "This will destroy ALL lobmob infrastructure (lobboss + VPC + firewalls)"
  read -rp "Are you sure? [y/N] " confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    cmd_teardown_all 2>/dev/null || true
    load_secrets
    cd "$INFRA_DIR" && terraform destroy -auto-approve
    log "All infrastructure destroyed"
  fi
}

cmd_spawn() {
  LOBBOSS_IP=$(get_lobboss_ip)
  if [ -z "$LOBBOSS_IP" ]; then
    err "Lobboss not deployed. Run: lobmob deploy"
    exit 1
  fi

  LOBSTER_ID="${1:-$(openssl rand -hex 4)}"
  log "Spawning lobster-$LOBSTER_ID via lobboss..."
  lobmob_ssh "root@$LOBBOSS_IP" "lobmob-spawn-lobster $LOBSTER_ID"
}

cmd_teardown() {
  if [ -z "${1:-}" ]; then
    err "Usage: lobmob teardown <lobster-name>"
    exit 1
  fi
  LOBBOSS_IP=$(get_lobboss_ip)
  log "Tearing down $1 via lobboss..."
  lobmob_ssh "root@$LOBBOSS_IP" "lobmob-teardown-lobster $1"
}

cmd_teardown_all() {
  LOBBOSS_IP=$(get_lobboss_ip)
  if [ -z "$LOBBOSS_IP" ]; then
    warn "Lobboss not reachable — attempting direct API teardown"
    load_secrets 2>/dev/null || true
    if [ -n "${DO_TOKEN:-}" ]; then
      curl -s -X DELETE "https://api.digitalocean.com/v2/droplets?tag_name=lobmob-lobster" \
        -H "Authorization: Bearer $DO_TOKEN"
      log "Sent bulk delete for all lobmob-lobster tagged droplets"
    else
      err "No DO token available"
    fi
    return
  fi

  log "Destroying all lobsters via lobboss..."
  lobmob_ssh "root@$LOBBOSS_IP" 'source /etc/lobmob/env && doctl compute droplet delete-by-tag "$LOBSTER_TAG" --force' || true
  log "All lobsters destroyed"
}

cmd_status() {
  LOBBOSS_IP=$(get_lobboss_ip)
  if [ -z "$LOBBOSS_IP" ]; then
    err "Lobboss not deployed"
    exit 1
  fi
  lobmob_ssh "root@$LOBBOSS_IP" "lobmob-fleet-status"
}

cmd_cleanup() {
  HOURS="${1:-2}"
  LOBBOSS_IP=$(get_lobboss_ip)
  lobmob_ssh "root@$LOBBOSS_IP" "lobmob-cleanup $HOURS"
}

cmd_vault_init() {
  log "Initializing vault repo..."

  if [ -z "${VAULT_REPO:-}" ]; then
    # Try to read from terraform.tfvars
    VAULT_REPO=$(grep vault_repo "$INFRA_DIR/terraform.tfvars" 2>/dev/null | cut -d'"' -f2 || true)
  fi
  if [ -z "${VAULT_REPO:-}" ]; then
    read -rp "Vault repo (org/name): " VAULT_REPO
  fi

  gh repo create "$VAULT_REPO" --private --description "lobmob swarm Obsidian vault"

  TMPDIR=$(mktemp -d)
  gh repo clone "$VAULT_REPO" "$TMPDIR"
  cp -r "$PROJECT_DIR/vault-seed/"* "$TMPDIR/"
  cp -r "$PROJECT_DIR/vault-seed/".obsidian "$TMPDIR/" 2>/dev/null || true
  cp -r "$PROJECT_DIR/vault-seed/".gitattributes "$TMPDIR/" 2>/dev/null || true

  cd "$TMPDIR"
  git add -A
  git commit -m "Seed vault structure"
  git push origin main

  mkdir -p 040-fleet/lobboss-skills 040-fleet/lobster-skills
  cp -r "$PROJECT_DIR/skills/lobboss/"* 040-fleet/lobboss-skills/
  cp -r "$PROJECT_DIR/skills/lobster/"* 040-fleet/lobster-skills/
  git add -A
  git commit -m "Add OpenClaw skills for fleet distribution"
  git push origin main

  rm -rf "$TMPDIR"
  log "Vault repo created: $VAULT_REPO"
}

cmd_vault_sync() {
  if [ -d "$PROJECT_DIR/vault-local" ]; then
    cd "$PROJECT_DIR/vault-local" && git pull origin main
  else
    VAULT_REPO=$(grep vault_repo "$INFRA_DIR/terraform.tfvars" 2>/dev/null | cut -d'"' -f2)
    gh repo clone "$VAULT_REPO" "$PROJECT_DIR/vault-local"
  fi
  log "Vault synced to $PROJECT_DIR/vault-local/"
}

cmd_sleep() {
  load_secrets

  LOBBOSS_ID=$(get_lobboss_id)
  if [ -z "$LOBBOSS_ID" ]; then
    err "Lobboss droplet not found. Is it deployed?"
    exit 1
  fi

  # Check if already off
  STATUS=$(doctl compute droplet get "$LOBBOSS_ID" \
    --format Status --no-header --access-token "$DO_TOKEN" 2>/dev/null)
  if [ "$STATUS" = "off" ]; then
    warn "Lobboss is already asleep"
    return
  fi

  # Cull all lobsters first
  log "Culling all lobsters before sleep..."
  LOBBOSS_IP=$(get_lobboss_ip)
  if [ -n "$LOBBOSS_IP" ]; then
    lobmob_ssh -o ConnectTimeout=10 "root@$LOBBOSS_IP" \
      'source /etc/lobmob/env && doctl compute droplet delete-by-tag "$LOBSTER_TAG" --force' 2>/dev/null || true
  fi
  # Belt-and-suspenders: also cull via API in case SSH missed any
  local PROJECT_NAME
  PROJECT_NAME=$(grep project_name "$INFRA_DIR/terraform.tfvars" 2>/dev/null | cut -d'"' -f2)
  PROJECT_NAME="${PROJECT_NAME:-lobmob}"
  curl -s -X DELETE \
    "https://api.digitalocean.com/v2/droplets?tag_name=${PROJECT_NAME}-lobster" \
    -H "Authorization: Bearer $DO_TOKEN" > /dev/null 2>&1 || true
  log "Lobsters culled"

  # Graceful shutdown
  log "Shutting down lobboss..."
  doctl compute droplet-action shutdown "$LOBBOSS_ID" \
    --access-token "$DO_TOKEN" --wait 2>/dev/null || true

  # Verify it's off — fall back to hard power-off if graceful shutdown stalled
  sleep 5
  STATUS=$(doctl compute droplet get "$LOBBOSS_ID" \
    --format Status --no-header --access-token "$DO_TOKEN" 2>/dev/null)
  if [ "$STATUS" != "off" ]; then
    warn "Graceful shutdown incomplete, forcing power off..."
    doctl compute droplet-action power-off "$LOBBOSS_ID" \
      --access-token "$DO_TOKEN" --wait
  fi

  log "Lobboss is asleep. Run 'lobmob wake' to resume."
}

cmd_wake() {
  load_secrets

  LOBBOSS_ID=$(get_lobboss_id)
  if [ -z "$LOBBOSS_ID" ]; then
    err "Lobboss droplet not found. Is it deployed?"
    exit 1
  fi

  # Check if already running
  STATUS=$(doctl compute droplet get "$LOBBOSS_ID" \
    --format Status --no-header --access-token "$DO_TOKEN" 2>/dev/null)
  if [ "$STATUS" = "active" ]; then
    warn "Lobboss is already awake"
    return
  fi

  log "Powering on lobboss..."
  doctl compute droplet-action power-on "$LOBBOSS_ID" \
    --access-token "$DO_TOKEN" --wait

  LOBBOSS_IP=$(get_lobboss_ip)
  wait_for_ssh "$LOBBOSS_IP"

  # Restart WireGuard (may not auto-start after power cycle)
  lobmob_ssh "root@$LOBBOSS_IP" "systemctl restart wg-quick@wg0" 2>/dev/null || true

  log "Lobboss is awake at $LOBBOSS_IP"
  log "  SSH:    lobmob ssh-lobboss"
  log "  Spawn:  lobmob spawn"
}

cmd_ssh_lobboss() {
  LOBBOSS_IP=$(get_lobboss_ip)
  log "Connecting to lobboss at $LOBBOSS_IP..."
  lobmob_ssh "root@$LOBBOSS_IP"
}

cmd_ssh_lobster() {
  if [ -z "${1:-}" ]; then
    err "Usage: lobmob ssh-lobster <wireguard-ip or lobster-id>"
    exit 1
  fi
  LOBBOSS_IP=$(get_lobboss_ip)
  TARGET="$1"
  if [[ ! "$TARGET" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    TARGET=$(lobmob_ssh "root@$LOBBOSS_IP" "grep '$TARGET' /opt/vault/040-fleet/registry.md | grep -oP 'wg_ip: \K\S+'" 2>/dev/null || echo "$TARGET")
  fi
  log "Connecting to lobster at $TARGET via lobboss tunnel..."
  lobmob_ssh -o ProxyJump="root@$LOBBOSS_IP" "root@$TARGET"
}

cmd_logs() {
  LOBBOSS_IP=$(get_lobboss_ip)
  lobmob_ssh "root@$LOBBOSS_IP" "tail -100f /var/log/cloud-init-output.log"
}

cmd_prs() {
  VAULT_REPO=$(grep vault_repo "$INFRA_DIR/terraform.tfvars" 2>/dev/null | cut -d'"' -f2)
  if [ -z "$VAULT_REPO" ]; then
    err "vault_repo not found in terraform.tfvars"
    exit 1
  fi
  gh pr list --repo "$VAULT_REPO" --state open
}

# --- Main ---

COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  bootstrap)           cmd_bootstrap ;;
  init)                cmd_init ;;
  deploy)              cmd_deploy ;;
  provision-secrets)   cmd_provision_secrets ;;
  destroy)             cmd_destroy ;;
  spawn)               cmd_spawn "$@" ;;
  teardown)            cmd_teardown "$@" ;;
  teardown-all)        cmd_teardown_all ;;
  status)              cmd_status ;;
  cleanup)             cmd_cleanup "$@" ;;
  vault-init)          cmd_vault_init ;;
  vault-sync)          cmd_vault_sync ;;
  sleep)               cmd_sleep ;;
  wake)                cmd_wake ;;
  ssh-lobboss)         cmd_ssh_lobboss ;;
  ssh-lobster)         cmd_ssh_lobster "$@" ;;
  logs)                cmd_logs ;;
  prs)                 cmd_prs ;;
  help|--help|-h)      usage ;;
  *)                   err "Unknown command: $COMMAND"; usage; exit 1 ;;
esac
