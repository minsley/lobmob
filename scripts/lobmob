#!/bin/bash
# lobmob â€” CLI for managing the agent swarm on DOKS
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || realpath "$0")")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
INFRA_DIR="$PROJECT_DIR/infra"

# Environment: prod (default) or dev
LOBMOB_ENV="${LOBMOB_ENV:-prod}"
_ARGS=()
for _arg in "$@"; do
  if [ "${_PREV_WAS_ENV:-}" = "1" ]; then
    LOBMOB_ENV="$_arg"
    _PREV_WAS_ENV=""
  elif [ "$_arg" = "--env" ] || [ "$_arg" = "-e" ]; then
    _PREV_WAS_ENV=1
  else
    _ARGS+=("$_arg")
  fi
done
set -- "${_ARGS[@]+"${_ARGS[@]}"}"

if [ "$LOBMOB_ENV" = "dev" ]; then
  SECRETS_FILE="$PROJECT_DIR/secrets-dev.env"
  TFVARS_FILE="$INFRA_DIR/dev.tfvars"
elif [ "$LOBMOB_ENV" = "local" ]; then
  SECRETS_FILE="$PROJECT_DIR/secrets-local.env"
  TFVARS_FILE=""  # no Terraform for local
else
  SECRETS_FILE="$PROJECT_DIR/secrets.env"
  TFVARS_FILE="$INFRA_DIR/prod.tfvars"
fi

# Load shared helpers
source "$SCRIPT_DIR/lib/helpers.sh"

usage() {
  cat <<EOF
Usage: lobmob [--env prod|dev|local] <command> [options]

Environment:
  --env, -e             Select environment (default: prod, or set LOBMOB_ENV)

Infrastructure:
  deploy              Deploy via Terraform + kubectl
  apply [--dry-run]   Apply k8s manifests only (no Terraform)
  destroy             Tear down infrastructure
  build <target>      Build and push container image to GHCR
                      Targets: base, lobboss, lobwife, lobsigliere, lobster, all
  restart <target>    Rollout restart a deployment and wait
  rollout <target>    Build, restart, and verify in one step

Connection:
  connect [target]    Port-forward to web dashboard + open browser
                      Targets: lobboss (default), lobwife, lobsigliere,
                      lobwife-ssh, or a lobster job name
  attach <job>        Attach to a running lobster: live events + inject guidance

Cluster (local only):
  cluster-create      Create local k3d cluster with labeled nodes
  cluster-delete      Delete local k3d cluster

Vault:
  vault-init          Initialize the Obsidian vault GitHub repo
  vault-sync          Pull latest vault to local machine

Secrets:
  secrets push        Push secrets.env to k8s lobmob-secrets
  secrets push-broker Push GitHub App creds to k8s lobwife-secrets
  secrets show        Show which secrets are configured

Setup:
  setup               Interactive bootstrap wizard
  setup github        Create GitHub App via manifest flow
  setup rotate-pem    Rotate the GitHub App PEM key

Utilities:
  status              Show fleet status
  verify [target]     Post-deploy verification (lobwife, lobboss, all)
  logs [target]       Tail pod logs (lobboss, lobwife, lobsigliere, or job name)
  flush-logs          Flush event logs to the vault
  prs                 List open PRs on the vault repo
EOF
}

COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  deploy)              source "$SCRIPT_DIR/commands/deploy.sh" ;;
  apply)               source "$SCRIPT_DIR/commands/apply.sh" ;;
  destroy)             source "$SCRIPT_DIR/commands/destroy.sh" ;;
  build)               source "$SCRIPT_DIR/commands/build.sh" ;;
  restart)             source "$SCRIPT_DIR/commands/restart.sh" ;;
  rollout)             source "$SCRIPT_DIR/commands/rollout.sh" ;;
  secrets)             source "$SCRIPT_DIR/commands/secrets.sh" ;;
  status)              source "$SCRIPT_DIR/commands/status.sh" ;;
  verify)              source "$SCRIPT_DIR/commands/verify.sh" ;;
  vault-init)          source "$SCRIPT_DIR/commands/vault-init.sh" ;;
  vault-sync)          source "$SCRIPT_DIR/commands/vault-sync.sh" ;;
  logs)                source "$SCRIPT_DIR/commands/logs.sh" ;;
  flush-logs)          source "$SCRIPT_DIR/commands/flush-logs.sh" ;;
  prs)                 source "$SCRIPT_DIR/commands/prs.sh" ;;
  connect)             source "$SCRIPT_DIR/commands/connect.sh" ;;
  attach)              source "$SCRIPT_DIR/commands/attach.sh" ;;
  cluster-create)      source "$SCRIPT_DIR/commands/cluster-create.sh" ;;
  cluster-delete)      source "$SCRIPT_DIR/commands/cluster-delete.sh" ;;
  setup)
    SETUP_CMD="${1:-}"
    shift || true
    case "$SETUP_CMD" in
      ""|wizard)    source "$SCRIPT_DIR/commands/setup.sh" ;;
      github)       source "$SCRIPT_DIR/commands/setup-github.sh" ;;
      rotate-pem)   source "$SCRIPT_DIR/commands/setup-rotate-pem.sh" ;;
      *)            err "Unknown setup command: $SETUP_CMD"; exit 1 ;;
    esac
    ;;
  help|--help|-h)      usage ;;
  *)                   err "Unknown command: $COMMAND"; usage; exit 1 ;;
esac
