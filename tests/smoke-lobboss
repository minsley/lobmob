#!/bin/bash
# smoke-lobboss â€” verify a deployed lobboss is healthy
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
INFRA_DIR="$PROJECT_DIR/infra"
LOBMOB_SSH_KEY="$HOME/.ssh/lobmob_ed25519"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

lobmob_ssh() {
  ssh -i "$LOBMOB_SSH_KEY" -o StrictHostKeyChecking=accept-new "$@"
}

get_lobboss_ip() {
  terraform -chdir="$INFRA_DIR" output -raw lobboss_ip 2>/dev/null
}

# --- Test runner ---

PASS_COUNT=0
FAIL_COUNT=0

check() {
  local label="$1"
  shift
  if "$@" >/dev/null 2>&1; then
    echo -e "  ${GREEN}PASS${NC}  $label"
    PASS_COUNT=$((PASS_COUNT + 1))
  else
    echo -e "  ${RED}FAIL${NC}  $label"
    FAIL_COUNT=$((FAIL_COUNT + 1))
  fi
}

# --- Resolve lobboss IP ---

LOBBOSS_IP=$(get_lobboss_ip)
if [ -z "$LOBBOSS_IP" ]; then
  echo -e "${RED}Cannot resolve lobboss IP from Terraform state.${NC}"
  echo "Is lobboss deployed? Run: lobmob deploy"
  exit 1
fi

echo ""
echo -e "${YELLOW}smoke-lobboss${NC}  $LOBBOSS_IP"
echo ""

# --- Checks ---

check "SSH reachable" \
  lobmob_ssh -o ConnectTimeout=10 -o BatchMode=yes "root@$LOBBOSS_IP" true

check "Cloud-init completed" \
  lobmob_ssh -o ConnectTimeout=10 "root@$LOBBOSS_IP" \
  "cloud-init status 2>/dev/null | grep -qE '(done|disabled)'"

check "WireGuard interface up" \
  lobmob_ssh "root@$LOBBOSS_IP" "wg show wg0"

check "Tool: gh" \
  lobmob_ssh "root@$LOBBOSS_IP" "command -v gh"

check "Tool: doctl" \
  lobmob_ssh "root@$LOBBOSS_IP" "command -v doctl"

check "Tool: node" \
  lobmob_ssh "root@$LOBBOSS_IP" "command -v node"

check "Tool: openclaw" \
  lobmob_ssh "root@$LOBBOSS_IP" "command -v openclaw"

check "Secrets provisioned (secrets.env exists)" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -f /etc/lobmob/secrets.env"

check "Secrets provisioned (.awaiting-secrets absent)" \
  lobmob_ssh "root@$LOBBOSS_IP" "test ! -f /etc/lobmob/.awaiting-secrets"

check "Vault cloned" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -d /opt/vault/.git"

check "Git identity configured" \
  lobmob_ssh "root@$LOBBOSS_IP" "git config --global user.name | grep -q ."

check "OpenClaw config exists" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -f /root/.openclaw/openclaw.json"

check "OpenClaw .env exists" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -f /root/.openclaw/.env"

check "OpenClaw gateway running" \
  lobmob_ssh "root@$LOBBOSS_IP" "systemctl is-active openclaw-gateway"

check "GH token script exists" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -f /usr/local/bin/lobmob-gh-token"

check "Web UI script exists" \
  lobmob_ssh "root@$LOBBOSS_IP" "test -f /usr/local/bin/lobmob-web"

check "Cron: cleanup" \
  lobmob_ssh "root@$LOBBOSS_IP" "grep -q lobmob-cleanup /etc/crontab"

check "Cron: PR review" \
  lobmob_ssh "root@$LOBBOSS_IP" "grep -q lobmob-review-prs /etc/crontab"

# --- Summary ---

TOTAL=$((PASS_COUNT + FAIL_COUNT))
echo ""
echo -e "${GREEN}$PASS_COUNT${NC}/$TOTAL passed"
if [ "$FAIL_COUNT" -gt 0 ]; then
  echo -e "${RED}$FAIL_COUNT failed${NC}"
  exit 1
fi
