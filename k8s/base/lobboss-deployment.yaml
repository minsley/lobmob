apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobboss
  namespace: lobmob
  labels:
    app.kubernetes.io/name: lobboss
    app.kubernetes.io/part-of: lobmob
spec:
  replicas: 1
  strategy:
    type: Recreate  # only one lobboss at a time (vault PVC is RWO)
  selector:
    matchLabels:
      app.kubernetes.io/name: lobboss
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lobboss
        app.kubernetes.io/part-of: lobmob
    spec:
      nodeSelector:
        lobmob.io/role: lobboss
      serviceAccountName: lobboss
      imagePullSecrets:
        - name: ghcr-pull-secret
      # Init container: clone or pull the vault repo using broker service token
      initContainers:
        - name: vault-init
          image: alpine/git:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Wait for lobwife broker to be ready (up to 60s)
              for i in $(seq 1 12); do
                TOKEN=$(wget -qO- --post-data='{"service":"lobboss-init"}' \
                  --header='Content-Type: application/json' \
                  "${LOBWIFE_URL}/api/v1/service-token" 2>/dev/null \
                  | sed -n 's/.*"token":"\([^"]*\)".*/\1/p') || true
                if [ -n "$TOKEN" ]; then break; fi
                echo "Waiting for lobwife broker (attempt $i/12)..."
                sleep 5
              done
              if [ -z "$TOKEN" ]; then
                echo "ERROR: Could not get broker token after 60s"
                exit 1
              fi
              if [ -d /opt/vault/.git ]; then
                cd /opt/vault && git reset --hard HEAD && git pull origin main || true
              else
                rm -rf /opt/vault/lost+found
                git clone "https://x-access-token:${TOKEN}@github.com/${VAULT_REPO}.git" /opt/vault
              fi
              cd /opt/vault
              git config user.name "lobboss"
              git config user.email "lobboss@lobmob.local"
          env:
            - name: VAULT_REPO
              valueFrom:
                configMapKeyRef:
                  name: lobboss-config
                  key: VAULT_REPO
            - name: LOBWIFE_URL
              valueFrom:
                configMapKeyRef:
                  name: lobboss-config
                  key: LOBWIFE_URL
          volumeMounts:
            - name: vault
              mountPath: /opt/vault
      containers:
        - name: lobboss
          image: ghcr.io/minsley/lobmob-lobboss:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: SERVICE_NAME
              value: "lobboss"
          envFrom:
            - secretRef:
                name: lobmob-secrets
            - configMapRef:
                name: lobboss-config
          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1536Mi"
              cpu: "900m"
          volumeMounts:
            - name: vault
              mountPath: /opt/vault
            - name: health-data
              mountPath: /tmp/health
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "from lobboss.bot import health_check; health_check()"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 10
      volumes:
        - name: vault
          persistentVolumeClaim:
            claimName: vault-pvc
        - name: health-data
          emptyDir: {}
      restartPolicy: Always
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lobboss-config
  namespace: lobmob
data:
  VAULT_PATH: "/opt/vault"
  LOBWIFE_URL: "http://lobwife.lobmob.svc.cluster.local:8081"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: lobboss
  namespace: lobmob
  labels:
    app.kubernetes.io/name: lobboss
    app.kubernetes.io/part-of: lobmob
---
# lobboss needs permissions to create/list/delete Jobs (for spawning lobsters)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: lobboss-role
  namespace: lobmob
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: lobboss-rolebinding
  namespace: lobmob
subjects:
  - kind: ServiceAccount
    name: lobboss
    namespace: lobmob
roleRef:
  kind: Role
  name: lobboss-role
  apiGroup: rbac.authorization.k8s.io
