#cloud-config
#
# Lobboss cloud-init -- CONTAINS NO SECRETS.
# Installs packages, scripts, and config skeletons.
# Secrets are pushed via SSH after boot by `lobmob deploy`.

package_update: true
package_upgrade: true

packages:
  - wireguard
  - git
  - jq
  - curl
  - unzip

write_files:
  # WireGuard skeleton -- private key injected by provision script
  - path: /etc/wireguard/wg0.conf.template
    permissions: "0600"
    content: |
      [Interface]
      PrivateKey = __WG_PRIVATE_KEY__
      Address = 10.0.0.1/24
      ListenPort = 51820
      SaveConfig = true

  # Non-secret config only -- secrets appended by provision script
  - path: /etc/lobmob/env
    permissions: "0600"
    content: |
      VAULT_REPO=${vault_repo}
      PROJECT_NAME=${project_name}
      LOBSTER_SIZE=${lobster_size}
      REGION=${region}
      SSH_KEY_ID=${ssh_key_id}
      VPC_UUID=${vpc_uuid}
      LOBSTER_TAG=${lobster_tag}
      POOL_ACTIVE=1
      POOL_STANDBY=2

  # SSH config skeleton for GitHub -- deploy key pushed by provision script
  - path: /root/.ssh/config
    permissions: "0644"
    content: |
      Host github.com
        IdentityFile /root/.ssh/vault_key
        StrictHostKeyChecking accept-new

  # Provision script -- called by `lobmob deploy` via SSH after secrets are pushed
  - path: /usr/local/bin/lobmob-provision
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      echo "=== lobmob provision: configuring lobboss ==="

      # Validate secrets exist
      source /etc/lobmob/secrets.env 2>/dev/null || { echo "ERROR: /etc/lobmob/secrets.env not found"; exit 1; }
      for VAR in DO_TOKEN GH_TOKEN DISCORD_BOT_TOKEN ANTHROPIC_API_KEY; do
        if [ -z "$${!VAR:-}" ]; then
          echo "ERROR: $VAR not set in secrets.env"
          exit 1
        fi
      done

      # Validate deploy key
      if [ ! -f /root/.ssh/vault_key ]; then
        echo "ERROR: /root/.ssh/vault_key not found"
        exit 1
      fi
      chmod 600 /root/.ssh/vault_key

      # Activate WireGuard
      if [ -f /etc/wireguard/wg0.conf ]; then
        wg-quick up wg0 2>/dev/null || true
        systemctl enable wg-quick@wg0
        echo "WireGuard: active"
      else
        echo "ERROR: /etc/wireguard/wg0.conf not found -- was WG private key pushed?"
        exit 1
      fi

      # Authenticate GitHub CLI
      echo "$GH_TOKEN" | gh auth login --with-token
      gh auth setup-git
      echo "GitHub CLI: authenticated"

      # Re-set git identity (gh auth setup-git clobbers .gitconfig)
      git config --global user.name "lobboss"
      git config --global user.email "lobboss@lobmob.swarm"

      # Authenticate doctl
      doctl auth init -t "$DO_TOKEN"
      echo "doctl: authenticated"

      # Clone vault repo
      source /etc/lobmob/env
      if [ ! -d /opt/vault/.git ]; then
        gh repo clone "$VAULT_REPO" /opt/vault
        cd /opt/vault && git checkout main
        echo "Vault: cloned"
      else
        cd /opt/vault && git pull origin main
        echo "Vault: updated"
      fi

      # Configure OpenClaw
      mkdir -p /root/.openclaw/skills
      cat > /root/.openclaw/config.json <<OCEOF
      {
        "defaultModel": "anthropic:claude-sonnet-4-5-20250929",
        "anthropicApiKey": "$ANTHROPIC_API_KEY",
        "channels": {
          "discord": {
            "enabled": true,
            "token": "$DISCORD_BOT_TOKEN"
          }
        }
      }
      OCEOF
      chmod 600 /root/.openclaw/config.json

      # Copy lobboss skills and AGENTS.md from vault
      cp -r /opt/vault/040-fleet/lobboss-skills/* /root/.openclaw/skills/ 2>/dev/null || true
      cp /opt/vault/040-fleet/lobboss-AGENTS.md /root/.openclaw/AGENTS.md 2>/dev/null || true

      # Generate SSH keypair for lobboss -> lobster connections
      if [ ! -f /root/.ssh/lobster_admin ]; then
        ssh-keygen -t ed25519 -C "lobboss-to-lobster" -f /root/.ssh/lobster_admin -N "" -q
        echo "SSH keypair for lobster access: generated"
      fi

      # Remove provision marker
      rm -f /etc/lobmob/.awaiting-secrets

      echo "=== lobmob provision: complete ==="

  # Lobster spawn script -- creates droplets with SECRET-FREE cloud-init,
  # then pushes secrets via SSH over WireGuard after boot
  - path: /usr/local/bin/lobmob-spawn-lobster
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env

      LOBSTER_ID="$${1:-$(openssl rand -hex 4)}"
      WG_IP="$${2:-}"

      if [ -z "$WG_IP" ]; then
        EXISTING=$(wg show wg0 allowed-ips 2>/dev/null | awk '{print $2}' | cut -d/ -f1 | sort -t. -k4 -n | tail -1)
        LAST_OCTET=$(echo "$${EXISTING:-10.0.0.1}" | cut -d. -f4)
        NEXT_OCTET=$((LAST_OCTET + 1))
        WG_IP="10.0.0.$${NEXT_OCTET}"
      fi

      # Read lobboss SSH public key for injecting into lobster authorized_keys
      LOBBOSS_SSH_PUBKEY=$(cat /root/.ssh/lobster_admin.pub)

      # Generate WireGuard keypair for lobster
      LOBSTER_WG_PRIVKEY=$(wg genkey)
      LOBSTER_WG_PUBKEY=$(echo "$LOBSTER_WG_PRIVKEY" | wg pubkey)
      LOBBOSS_PUB_IP=$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)
      LOBBOSS_WG_PUBKEY=$(wg show wg0 public-key)

      # Build SECRET-FREE cloud-init for lobster
      # Only contains: packages, WireGuard config (ephemeral key -- not a stored secret),
      # SSH authorized keys, git identity, Node.js, OpenClaw, gh CLI install
      LOBSTER_USERDATA=$(cat <<USERDATA
      #!/bin/bash
      set -euo pipefail

      export DEBIAN_FRONTEND=noninteractive
      export HOME=/root
      apt-get update
      apt-get install -y wireguard git jq curl unzip

      # WireGuard -- uses ephemeral keypair generated by lobboss at spawn time
      cat > /etc/wireguard/wg0.conf <<WGEOF
      [Interface]
      PrivateKey = $LOBSTER_WG_PRIVKEY
      Address = $WG_IP/24
      ListenPort = 51820

      [Peer]
      PublicKey = $LOBBOSS_WG_PUBKEY
      AllowedIPs = 10.0.0.0/24
      Endpoint = $LOBBOSS_PUB_IP:51820
      PersistentKeepalive = 25
      WGEOF

      wg-quick up wg0
      systemctl enable wg-quick@wg0

      # SSH authorized keys: DO metadata + lobboss admin key
      mkdir -p /root/.ssh
      curl -s http://169.254.169.254/metadata/v1/public-keys >> /root/.ssh/authorized_keys
      printf '\n%s\n' "$LOBBOSS_SSH_PUBKEY" >> /root/.ssh/authorized_keys

      # Git identity only -- no auth tokens
      git config --global user.name "lobster-$LOBSTER_ID"
      git config --global user.email "lobster-$LOBSTER_ID@lobmob.swarm"

      # Install GitHub CLI (auth happens via lobboss SSH push)
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
      echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        > /etc/apt/sources.list.d/github-cli.list
      apt-get update && apt-get install -y gh

      # Node.js 22
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs

      # OpenClaw (config written later by lobboss via SSH)
      npm install -g openclaw@latest
      mkdir -p /root/.openclaw/skills /etc/lobmob

      # Non-secret config
      cat > /etc/lobmob/env <<ENVEOF
      LOBSTER_ID=$LOBSTER_ID
      WG_IP=$WG_IP
      ENVEOF

      # Signal awaiting secrets
      touch /etc/lobmob/.awaiting-secrets

      USERDATA
      )

      # Create the droplet
      RESPONSE=$(doctl compute droplet create \
        "lobster-$LOBSTER_ID" \
        --region "$REGION" \
        --size "$LOBSTER_SIZE" \
        --image ubuntu-24-04-x64 \
        --ssh-keys "$SSH_KEY_ID" \
        --vpc-uuid "$VPC_UUID" \
        --tag-name "$LOBSTER_TAG" \
        --user-data "$LOBSTER_USERDATA" \
        --wait \
        --format ID,PublicIPv4 \
        --no-header \
        --output json)

      DROPLET_ID=$(echo "$RESPONSE" | jq -r '.[0].id')
      DROPLET_IP=$(echo "$RESPONSE" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')

      # Add lobster as WireGuard peer on lobboss
      wg set wg0 peer "$LOBSTER_WG_PUBKEY" allowed-ips "$WG_IP/32" endpoint "$DROPLET_IP:51820"

      echo "Droplet created. Waiting for WireGuard connectivity..."
      for i in $(seq 1 30); do
        if ping -c 1 -W 2 "$WG_IP" > /dev/null 2>&1; then
          echo "WireGuard: connected to $WG_IP"
          break
        fi
        sleep 5
      done

      # Wait for cloud-init to finish
      echo "Waiting for cloud-init to complete on lobster..."
      ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new "root@$WG_IP" \
        "cloud-init status --wait" 2>/dev/null || true
      echo "Cloud-init: done"

      # Push secrets to lobster via SSH over WireGuard
      echo "Pushing secrets to lobster via SSH..."

      # Write secrets.env
      ssh -i /root/.ssh/lobster_admin -o StrictHostKeyChecking=accept-new "root@$WG_IP" "cat > /etc/lobmob/secrets.env && chmod 600 /etc/lobmob/secrets.env" <<SECRETS
      GH_TOKEN=$GH_TOKEN
      DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
      ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY
      SECRETS

      # Authenticate gh and clone vault
      ssh -i /root/.ssh/lobster_admin -o StrictHostKeyChecking=accept-new "root@$WG_IP" bash <<PROVISION
      set -euo pipefail
      source /etc/lobmob/secrets.env

      # GitHub auth
      echo "\$GH_TOKEN" | gh auth login --with-token
      gh auth setup-git

      # Re-set git identity (gh auth setup-git clobbers .gitconfig)
      git config --global user.name "lobster-$LOBSTER_ID"
      git config --global user.email "lobster-$LOBSTER_ID@lobmob.swarm"

      # Clone vault
      source /etc/lobmob/env
      gh repo clone "$VAULT_REPO" /opt/vault 2>/dev/null || (cd /opt/vault && git pull origin main)
      cd /opt/vault && git checkout main

      # OpenClaw config
      cat > /root/.openclaw/config.json <<OCEOF
      {
        "defaultModel": "anthropic:claude-sonnet-4-5-20250929",
        "anthropicApiKey": "\$ANTHROPIC_API_KEY",
        "channels": {
          "discord": {
            "enabled": true,
            "token": "\$DISCORD_BOT_TOKEN"
          }
        }
      }
      OCEOF
      chmod 600 /root/.openclaw/config.json

      # Copy lobster skills
      cp -r /opt/vault/040-fleet/lobster-skills/* /root/.openclaw/skills/ 2>/dev/null || true

      # Write lobster AGENTS.md
      cat > /root/.openclaw/AGENTS.md <<AGENTEOF
      ---
      name: lobster-$LOBSTER_ID
      model: anthropic:claude-sonnet-4-5-20250929
      ---
      You are lobster-$LOBSTER_ID in the lobmob swarm. Your WireGuard IP is $WG_IP.
      You execute tasks assigned by lobboss via Discord #swarm-control.
      When you complete a task:
      1. Write results to the vault repo under /opt/vault/
      2. Create a PR using the submit-results skill
      3. Post a summary with PR link to #results
      Report failures honestly. Self-destruct when idle too long.
      AGENTEOF

      # Mark secrets provisioned
      rm -f /etc/lobmob/.awaiting-secrets
      echo "LOBSTER_READY"
      PROVISION

      echo "Lobster provisioned."

      # Write config version to lobster for pool management staleness checks
      CONFIG_VERSION=$(md5sum /usr/local/bin/lobmob-spawn-lobster | awk '{print $1}')
      ssh -i /root/.ssh/lobster_admin -o StrictHostKeyChecking=accept-new "root@$WG_IP" \
        "echo '$CONFIG_VERSION' > /etc/lobmob/config-version"

      lobmob-log spawn "lobster-$LOBSTER_ID droplet=$DROPLET_ID wg_ip=$WG_IP"

      # Output lobster info as JSON
      cat <<EOF
      {
        "lobster_id": "lobster-$LOBSTER_ID",
        "droplet_id": "$DROPLET_ID",
        "public_ip": "$DROPLET_IP",
        "wireguard_ip": "$WG_IP",
        "wg_public_key": "$LOBSTER_WG_PUBKEY"
      }
      EOF

  # Lobster teardown script
  - path: /usr/local/bin/lobmob-teardown-lobster
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env

      LOBSTER_NAME="$1"

      # Get droplet ID and public IP
      DROPLET_INFO=$(doctl compute droplet list \
        --tag-name "$LOBSTER_TAG" \
        --format ID,Name,PublicIPv4 \
        --no-header | grep "$LOBSTER_NAME")

      DROPLET_ID=$(echo "$DROPLET_INFO" | awk '{print $1}')
      DROPLET_IP=$(echo "$DROPLET_INFO" | awk '{print $3}')

      if [ -z "$DROPLET_ID" ]; then
        echo "Lobster $LOBSTER_NAME not found"
        exit 1
      fi

      # Best-effort: flush lobster's event log before destroy
      WG_IP=$(wg show wg0 allowed-ips 2>/dev/null | while read -r PK ALLOWED; do
        IP=$(echo "$ALLOWED" | cut -d/ -f1)
        REMOTE_ID=$(ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=3 -o StrictHostKeyChecking=accept-new \
          "root@$IP" "cat /etc/lobmob/env 2>/dev/null | grep LOBSTER_ID | cut -d= -f2" 2>/dev/null || true)
        if echo "$LOBSTER_NAME" | grep -q "$REMOTE_ID" 2>/dev/null && [ -n "$REMOTE_ID" ]; then
          echo "$IP"; break
        fi
      done)
      if [ -n "$WG_IP" ]; then
        ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
          "root@$WG_IP" "lobmob-flush-logs" 2>/dev/null || true
      fi

      # Remove WireGuard peer by matching endpoint IP
      WG_PUBKEY=""
      if [ -n "$DROPLET_IP" ]; then
        WG_PUBKEY=$(wg show wg0 endpoints 2>/dev/null \
          | grep "$DROPLET_IP:" | awk '{print $1}' || true)
      fi
      # Fallback: check vault registry
      if [ -z "$WG_PUBKEY" ]; then
        WG_PUBKEY=$(grep "$LOBSTER_NAME" /opt/vault/040-fleet/registry.md 2>/dev/null \
          | grep -oP 'wg_pubkey: \K\S+' || true)
      fi
      if [ -n "$WG_PUBKEY" ]; then
        wg set wg0 peer "$WG_PUBKEY" remove
        echo "Removed WireGuard peer $WG_PUBKEY"
      fi

      # Destroy droplet
      doctl compute droplet delete "$DROPLET_ID" --force

      lobmob-log destroy "$LOBSTER_NAME droplet=$DROPLET_ID"
      echo "Destroyed $LOBSTER_NAME (droplet $DROPLET_ID)"

  # Fleet status script
  - path: /usr/local/bin/lobmob-fleet-status
    permissions: "0755"
    content: |
      #!/bin/bash
      source /etc/lobmob/env

      POOL_ACTIVE="$${POOL_ACTIVE:-1}"
      POOL_STANDBY="$${POOL_STANDBY:-2}"
      CONFIG_VERSION=$(md5sum /usr/local/bin/lobmob-spawn-lobster 2>/dev/null | awk '{print $1}')

      echo "=== Pool Config ==="
      echo "  POOL_ACTIVE=$POOL_ACTIVE  POOL_STANDBY=$POOL_STANDBY"
      echo "  Config version: $${CONFIG_VERSION:0:8}..."
      echo ""

      echo "=== Lobster Droplets ==="
      DROPLETS=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format ID,Name,PublicIPv4,Status,Created --no-header 2>/dev/null)
      if [ -z "$DROPLETS" ]; then
        echo "  (none)"
      else
        echo "$DROPLETS"
      fi

      # Classify by state
      BUSY=0
      IDLE=0
      STANDBY_COUNT=0
      while read -r ID NAME _ STATUS _; do
        [ -z "$ID" ] && continue
        if [ "$STATUS" = "off" ]; then
          STANDBY_COUNT=$((STANDBY_COUNT + 1))
        elif [ "$STATUS" = "active" ]; then
          LOBSTER_SHORT=$(echo "$NAME" | sed 's/^lobster-//')
          if grep -rl "$LOBSTER_SHORT" /opt/vault/010-tasks/active/ 2>/dev/null | head -1 | grep -q .; then
            BUSY=$((BUSY + 1))
          else
            IDLE=$((IDLE + 1))
          fi
        fi
      done <<< "$DROPLETS"

      echo ""
      echo "=== Pool State ==="
      echo "  active-busy: $BUSY"
      echo "  active-idle: $IDLE (target: $POOL_ACTIVE)"
      echo "  standby:     $STANDBY_COUNT (target: $POOL_STANDBY)"
      echo ""

      echo "=== WireGuard Peers ==="
      wg show wg0

      echo ""
      echo "=== Open PRs ==="
      cd /opt/vault && gh pr list --state open --json number,title,headRefName,author,createdAt 2>/dev/null || echo "No vault repo"

  # Pool-aware cleanup (replaces age-based cleanup)
  - path: /usr/local/bin/lobmob-cleanup
    permissions: "0755"
    content: |
      #!/bin/bash
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env 2>/dev/null || true

      POOL_ACTIVE="$${POOL_ACTIVE:-1}"
      POOL_STANDBY="$${POOL_STANDBY:-2}"
      HARD_MAX_HOURS=24
      NOW=$(date +%s)

      # Get all lobster droplets
      DROPLETS=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format ID,Name,Status,Created --no-header 2>/dev/null)
      if [ -z "$DROPLETS" ]; then
        exit 0
      fi

      # Classify droplets
      ACTIVE_IDLE=()
      STANDBY=()
      SLEPT=0
      DESTROYED=0
      AGED_OUT=0

      while read -r ID NAME STATUS CREATED; do
        # Hard ceiling: destroy ANY lobster older than 24h
        CREATED_TS=$(date -d "$CREATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED" +%s 2>/dev/null)
        AGE_HOURS=$(( (NOW - CREATED_TS) / 3600 ))
        if [ "$AGE_HOURS" -ge "$HARD_MAX_HOURS" ]; then
          echo "Destroying lobster $NAME (age: $${AGE_HOURS}h exceeds $${HARD_MAX_HOURS}h ceiling)"
          lobmob-teardown-lobster "$NAME"
          AGED_OUT=$((AGED_OUT + 1))
          continue
        fi

        if [ "$STATUS" = "off" ]; then
          STANDBY+=("$NAME")
        elif [ "$STATUS" = "active" ]; then
          # Check if busy (has active task in vault)
          BUSY=0
          if ls /opt/vault/010-tasks/active/*"$NAME"* 2>/dev/null | grep -q .; then
            BUSY=1
          fi
          if [ "$BUSY" -eq 0 ]; then
            ACTIVE_IDLE+=("$NAME")
          fi
        fi
      done <<< "$DROPLETS"

      # Sleep excess idle lobsters beyond POOL_ACTIVE
      IDLE_COUNT=$${#ACTIVE_IDLE[@]}
      if [ "$IDLE_COUNT" -gt "$POOL_ACTIVE" ]; then
        EXCESS=$(( IDLE_COUNT - POOL_ACTIVE ))
        echo "Sleeping $EXCESS excess idle lobsters (have $IDLE_COUNT, want $POOL_ACTIVE)"
        for (( i=0; i<EXCESS; i++ )); do
          lobmob-sleep-lobster "$${ACTIVE_IDLE[$i]}"
          SLEPT=$((SLEPT + 1))
        done
      fi

      # Destroy excess standby lobsters beyond POOL_STANDBY
      STANDBY_COUNT=$${#STANDBY[@]}
      if [ "$STANDBY_COUNT" -gt "$POOL_STANDBY" ]; then
        EXCESS=$(( STANDBY_COUNT - POOL_STANDBY ))
        echo "Destroying $EXCESS excess standby lobsters (have $STANDBY_COUNT, want $POOL_STANDBY)"
        for (( i=0; i<EXCESS; i++ )); do
          lobmob-teardown-lobster "$${STANDBY[$i]}"
          DESTROYED=$((DESTROYED + 1))
        done
      fi

      lobmob-log cleanup "slept=$SLEPT destroyed=$DESTROYED aged_out=$AGED_OUT"

  # Sleep lobster script -- powers off a lobster, preserving disk
  - path: /usr/local/bin/lobmob-sleep-lobster
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env

      LOBSTER_NAME="$1"

      # Look up droplet ID
      DROPLET_ID=$(doctl compute droplet list \
        --tag-name "$LOBSTER_TAG" \
        --format ID,Name \
        --no-header | grep "$LOBSTER_NAME" | awk '{print $1}')

      if [ -z "$DROPLET_ID" ]; then
        echo "Lobster $LOBSTER_NAME not found"
        exit 1
      fi

      echo "Sleeping $LOBSTER_NAME (droplet $DROPLET_ID)..."

      # Flush lobster's event log before sleep
      # Find WG IP by checking peers
      WG_IP=$(wg show wg0 allowed-ips 2>/dev/null | while read -r PK ALLOWED; do
        IP=$(echo "$ALLOWED" | cut -d/ -f1)
        REMOTE_ID=$(ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=3 -o StrictHostKeyChecking=accept-new \
          "root@$IP" "cat /etc/lobmob/env 2>/dev/null | grep LOBSTER_ID | cut -d= -f2" 2>/dev/null || true)
        if echo "$LOBSTER_NAME" | grep -q "$REMOTE_ID" 2>/dev/null && [ -n "$REMOTE_ID" ]; then
          echo "$IP"; break
        fi
      done)
      if [ -n "$WG_IP" ]; then
        ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
          "root@$WG_IP" "lobmob-flush-logs" 2>/dev/null || true
      fi

      # Graceful shutdown with timeout
      doctl compute droplet-action shutdown "$DROPLET_ID" --wait 2>/dev/null &
      SHUTDOWN_PID=$!
      TIMEOUT=120
      ELAPSED=0
      while kill -0 "$SHUTDOWN_PID" 2>/dev/null; do
        sleep 5
        ELAPSED=$((ELAPSED + 5))
        if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
          kill "$SHUTDOWN_PID" 2>/dev/null || true
          echo "Graceful shutdown timed out, forcing power-off..."
          doctl compute droplet-action power-off "$DROPLET_ID" --wait
          break
        fi
      done
      wait "$SHUTDOWN_PID" 2>/dev/null || true

      lobmob-log sleep "$LOBSTER_NAME droplet=$DROPLET_ID"
      echo "Lobster $LOBSTER_NAME is now standby (powered off)"

  # Wake lobster script -- powers on a standby lobster
  - path: /usr/local/bin/lobmob-wake-lobster
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env

      LOBSTER_NAME="$1"

      # Look up droplet info
      DROPLET_INFO=$(doctl compute droplet list \
        --tag-name "$LOBSTER_TAG" \
        --format ID,Name,Status \
        --no-header | grep "$LOBSTER_NAME")

      if [ -z "$DROPLET_INFO" ]; then
        echo "Lobster $LOBSTER_NAME not found"
        exit 1
      fi

      DROPLET_ID=$(echo "$DROPLET_INFO" | awk '{print $1}')
      DROPLET_STATUS=$(echo "$DROPLET_INFO" | awk '{print $3}')

      if [ "$DROPLET_STATUS" = "active" ]; then
        echo "Lobster $LOBSTER_NAME is already active"
        exit 0
      fi

      echo "Waking $LOBSTER_NAME (droplet $DROPLET_ID)..."
      doctl compute droplet-action power-on "$DROPLET_ID" --wait

      # Look up WG IP from wg show (the peer config survives power cycle)
      WG_IP=""
      while read -r PUBKEY ALLOWED; do
        IP=$(echo "$ALLOWED" | cut -d/ -f1)
        # Try to match -- we'll ping all peers and see which comes alive
        if ping -c 1 -W 2 "$IP" > /dev/null 2>&1; then
          # Verify it's our lobster by SSHing in
          REMOTE_NAME=$(ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
            "root@$IP" "cat /etc/lobmob/env 2>/dev/null | grep LOBSTER_ID | cut -d= -f2" 2>/dev/null || true)
          if echo "$LOBSTER_NAME" | grep -q "$REMOTE_NAME" 2>/dev/null && [ -n "$REMOTE_NAME" ]; then
            WG_IP="$IP"
            break
          fi
        fi
      done < <(wg show wg0 allowed-ips 2>/dev/null)

      # If no WG IP found via matching, scan all peers for connectivity
      if [ -z "$WG_IP" ]; then
        echo "Waiting for WireGuard connectivity..."
        for attempt in $(seq 1 30); do
          while read -r PUBKEY ALLOWED; do
            IP=$(echo "$ALLOWED" | cut -d/ -f1)
            if ping -c 1 -W 2 "$IP" > /dev/null 2>&1; then
              REMOTE_NAME=$(ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
                "root@$IP" "cat /etc/lobmob/env 2>/dev/null | grep LOBSTER_ID | cut -d= -f2" 2>/dev/null || true)
              if echo "$LOBSTER_NAME" | grep -q "$REMOTE_NAME" 2>/dev/null && [ -n "$REMOTE_NAME" ]; then
                WG_IP="$IP"
                break 2
              fi
            fi
          done < <(wg show wg0 allowed-ips 2>/dev/null)
          sleep 5
        done
      fi

      if [ -z "$WG_IP" ]; then
        echo "ERROR: Could not establish WireGuard connectivity to $LOBSTER_NAME"
        exit 1
      fi

      echo "WireGuard: connected at $WG_IP"

      # Wait for SSH
      echo "Waiting for SSH..."
      for i in $(seq 1 12); do
        if ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
          "root@$WG_IP" "true" 2>/dev/null; then
          break
        fi
        sleep 5
      done

      # Pull latest vault
      ssh -i /root/.ssh/lobster_admin -o StrictHostKeyChecking=accept-new "root@$WG_IP" \
        "cd /opt/vault && git pull origin main" 2>/dev/null || true

      # Refresh secrets
      ssh -i /root/.ssh/lobster_admin -o StrictHostKeyChecking=accept-new "root@$WG_IP" \
        "cat > /etc/lobmob/secrets.env && chmod 600 /etc/lobmob/secrets.env" <<SECRETS
      GH_TOKEN=$GH_TOKEN
      DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
      ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY
      SECRETS

      lobmob-log wake "$LOBSTER_NAME wg_ip=$WG_IP"
      echo "Lobster $LOBSTER_NAME is awake at $WG_IP"

      # Output lobster info as JSON
      cat <<EOF
      {
        "lobster_name": "$LOBSTER_NAME",
        "droplet_id": "$DROPLET_ID",
        "wireguard_ip": "$WG_IP",
        "status": "active"
      }
      EOF

  # Pool manager -- reconciliation loop for the lobster pool
  - path: /usr/local/bin/lobmob-pool-manager
    permissions: "0755"
    content: |
      #!/bin/bash
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env 2>/dev/null || true

      POOL_ACTIVE="$${POOL_ACTIVE:-1}"
      POOL_STANDBY="$${POOL_STANDBY:-2}"
      MAX_LOBSTERS=10

      echo "$(date -Iseconds) Pool manager: target active-idle=$POOL_ACTIVE standby=$POOL_STANDBY"

      # Get all lobster droplets
      DROPLETS=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format ID,Name,Status --no-header 2>/dev/null)

      ACTIVE_BUSY=()
      ACTIVE_IDLE=()
      STANDBY=()
      TOTAL=0

      while read -r ID NAME STATUS; do
        [ -z "$ID" ] && continue
        TOTAL=$((TOTAL + 1))
        if [ "$STATUS" = "off" ]; then
          STANDBY+=("$NAME")
        elif [ "$STATUS" = "active" ]; then
          # Check if lobster is busy (assigned to an active task in vault)
          BUSY=0
          cd /opt/vault 2>/dev/null && git pull origin main --quiet 2>/dev/null || true
          # Look for task files mentioning this lobster with status: active
          LOBSTER_SHORT=$(echo "$NAME" | sed 's/^lobster-//')
          if grep -rl "$LOBSTER_SHORT" /opt/vault/010-tasks/active/ 2>/dev/null | head -1 | grep -q .; then
            BUSY=1
          fi
          if [ "$BUSY" -eq 1 ]; then
            ACTIVE_BUSY+=("$NAME")
          else
            ACTIVE_IDLE+=("$NAME")
          fi
        fi
      done <<< "$DROPLETS"

      BUSY_COUNT=$${#ACTIVE_BUSY[@]}
      IDLE_COUNT=$${#ACTIVE_IDLE[@]}
      STANDBY_COUNT=$${#STANDBY[@]}

      echo "  Current: active-busy=$BUSY_COUNT active-idle=$IDLE_COUNT standby=$STANDBY_COUNT total=$TOTAL"

      # Current config version
      CONFIG_VERSION=$(md5sum /usr/local/bin/lobmob-spawn-lobster 2>/dev/null | awk '{print $1}')

      # Step 1: Destroy stale standby lobsters (config version mismatch)
      for NAME in "$${STANDBY[@]}"; do
        # Power on briefly to check? No -- too expensive. Check via doctl tags or stored metadata.
        # Instead, wake and check, or just track version at sleep time.
        # For now, we store config version on the lobster at spawn time and check via SSH after wake.
        # Stale detection happens during wake: if version mismatches, teardown instead.
        true
      done

      # Step 2: Need more idle active?
      if [ "$IDLE_COUNT" -lt "$POOL_ACTIVE" ]; then
        NEED=$((POOL_ACTIVE - IDLE_COUNT))
        echo "  Need $NEED more active-idle lobsters"

        for (( i=0; i<NEED; i++ )); do
          if [ "$TOTAL" -ge "$MAX_LOBSTERS" ]; then
            echo "  Hit max lobster limit ($MAX_LOBSTERS), skipping"
            break
          fi

          # Prefer waking standby over spawning new
          if [ "$STANDBY_COUNT" -gt 0 ]; then
            WAKE_NAME="$${STANDBY[0]}"
            echo "  Waking standby lobster: $WAKE_NAME"
            RESULT=$(lobmob-wake-lobster "$WAKE_NAME" 2>&1) || true
            echo "$RESULT"

            # Check config version after wake
            WG_IP=$(echo "$RESULT" | grep -oP '"wireguard_ip": "\K[^"]+' || true)
            if [ -n "$WG_IP" ]; then
              REMOTE_VERSION=$(ssh -i /root/.ssh/lobster_admin -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new \
                "root@$WG_IP" "cat /etc/lobmob/config-version 2>/dev/null" 2>/dev/null || true)
              if [ -n "$REMOTE_VERSION" ] && [ "$REMOTE_VERSION" != "$CONFIG_VERSION" ]; then
                echo "  Config version mismatch on $WAKE_NAME (got $REMOTE_VERSION, want $CONFIG_VERSION) -- destroying and spawning fresh"
                lobmob-teardown-lobster "$WAKE_NAME"
                lobmob-spawn-lobster
                TOTAL=$((TOTAL))  # net zero: destroyed one, spawned one
              fi
            fi

            # Remove from standby array
            STANDBY=("$${STANDBY[@]:1}")
            STANDBY_COUNT=$${#STANDBY[@]}
          else
            echo "  No standby available, spawning new lobster"
            lobmob-spawn-lobster
            TOTAL=$((TOTAL + 1))
          fi
        done
      fi

      # Step 3: Too many idle active? Sleep excess.
      if [ "$IDLE_COUNT" -gt "$POOL_ACTIVE" ]; then
        EXCESS=$((IDLE_COUNT - POOL_ACTIVE))
        echo "  Sleeping $EXCESS excess idle lobsters"
        for (( i=0; i<EXCESS; i++ )); do
          lobmob-sleep-lobster "$${ACTIVE_IDLE[$i]}"
        done
      fi

      # Step 4: Too many standby? Destroy excess.
      # Re-count standby (may have changed from waking)
      STANDBY_NOW=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format Name,Status --no-header 2>/dev/null \
        | awk '$2 == "off" {print $1}')
      STANDBY_COUNT_NOW=$(echo "$STANDBY_NOW" | grep -c . 2>/dev/null || echo 0)
      if [ "$STANDBY_COUNT_NOW" -gt "$POOL_STANDBY" ]; then
        EXCESS=$((STANDBY_COUNT_NOW - POOL_STANDBY))
        echo "  Destroying $EXCESS excess standby lobsters"
        echo "$STANDBY_NOW" | head -n "$EXCESS" | while read -r NAME; do
          lobmob-teardown-lobster "$NAME"
        done
      fi

      # Step 5: Pool underfilled? Spawn to fill.
      # Re-count everything
      CURRENT_IDLE=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format Name,Status --no-header 2>/dev/null \
        | awk '$2 == "active" {print $1}' | wc -l)
      CURRENT_STANDBY=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format Name,Status --no-header 2>/dev/null \
        | awk '$2 == "off" {print $1}' | wc -l)
      CURRENT_TOTAL=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format ID --no-header 2>/dev/null | wc -l)
      POOL_TARGET=$((POOL_ACTIVE + POOL_STANDBY))
      AVAILABLE=$((CURRENT_IDLE + CURRENT_STANDBY - BUSY_COUNT))
      if [ "$AVAILABLE" -lt "$POOL_TARGET" ] && [ "$CURRENT_TOTAL" -lt "$MAX_LOBSTERS" ]; then
        NEED=$((POOL_TARGET - AVAILABLE))
        CAPACITY=$((MAX_LOBSTERS - CURRENT_TOTAL))
        SPAWN=$(( NEED < CAPACITY ? NEED : CAPACITY ))
        echo "  Pool underfilled (available=$AVAILABLE, target=$POOL_TARGET). Spawning $SPAWN lobsters."
        for (( i=0; i<SPAWN; i++ )); do
          lobmob-spawn-lobster
        done
      fi

      # Log convergence result
      FINAL_ACTIVE=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format Status --no-header 2>/dev/null \
        | grep -c "active" || echo 0)
      FINAL_STANDBY=$(doctl compute droplet list --tag-name "$LOBSTER_TAG" --format Status --no-header 2>/dev/null \
        | grep -c "off" || echo 0)
      FINAL_TOTAL=$((FINAL_ACTIVE + FINAL_STANDBY))
      lobmob-log converge "active=$FINAL_ACTIVE standby=$FINAL_STANDBY total=$FINAL_TOTAL"

      echo "$(date -Iseconds) Pool manager: done"

  # PR review script
  - path: /usr/local/bin/lobmob-review-prs
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      cd /opt/vault

      git checkout main && git pull origin main

      PRS=$(gh pr list --state open --json number,title,headRefName --jq '.[]' 2>/dev/null)
      if [ -z "$PRS" ]; then
        exit 0
      fi

      echo "$PRS" | jq -c '.' | while read -r PR; do
        NUMBER=$(echo "$PR" | jq -r '.number')
        TITLE=$(echo "$PR" | jq -r '.title')
        BRANCH=$(echo "$PR" | jq -r '.headRefName')

        echo "Reviewing PR #$NUMBER: $TITLE ($BRANCH)"

        # Check diff for secrets
        DIFF=$(gh pr diff "$NUMBER" 2>/dev/null || true)
        if echo "$DIFF" | grep -qiE '(sk-ant-|dop_v1_|github_pat_|PRIVATE KEY)'; then
          gh pr comment "$NUMBER" --body "Possible secrets detected in diff. Please remove and force-push."
          echo "BLOCKED PR #$NUMBER -- secrets detected"
          continue
        fi

        # Check file paths are within allowed directories
        FILES=$(gh pr view "$NUMBER" --json files --jq '.files[].path')
        INVALID=$(echo "$FILES" | grep -vE '^(010-tasks/|020-logs/|030-knowledge/|000-inbox/)' || true)
        if [ -n "$INVALID" ]; then
          gh pr comment "$NUMBER" --body "Files outside allowed paths: $INVALID"
          echo "BLOCKED PR #$NUMBER -- invalid paths"
          continue
        fi

        echo "PR #$NUMBER passes checks -- ready for lobboss agent review"
      done

  # Event logger -- appends timestamped lines to /var/log/lobmob-events.log
  - path: /usr/local/bin/lobmob-log
    permissions: "0755"
    content: |
      #!/bin/bash
      CATEGORY="$1"; shift
      echo "$(date -Iseconds) [$CATEGORY] $*" >> /var/log/lobmob-events.log

  # Flush event log to vault and push
  - path: /usr/local/bin/lobmob-flush-logs
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      LOG_FILE="/var/log/lobmob-events.log"
      VAULT_DIR="/opt/vault"
      LOCK_FILE="/tmp/lobmob-flush.lock"

      # Nothing to flush
      if [ ! -s "$LOG_FILE" ]; then
        exit 0
      fi

      exec 200>"$LOCK_FILE"
      flock -n 200 || { echo "Another flush is running"; exit 0; }

      # Determine identity
      if [ -f /etc/lobmob/env ]; then
        source /etc/lobmob/env
      fi

      if [ -n "$${LOBSTER_ID:-}" ]; then
        LOG_SUBDIR="020-logs/lobsters/lobster-$LOBSTER_ID"
        COMMIT_PREFIX="[lobster-$LOBSTER_ID]"
      else
        LOG_SUBDIR="020-logs/lobboss"
        COMMIT_PREFIX="[lobboss]"
      fi

      TODAY=$(date +%Y-%m-%d)
      TARGET_FILE="$VAULT_DIR/$LOG_SUBDIR/events-$TODAY.log"

      cd "$VAULT_DIR"
      git pull origin main --quiet 2>/dev/null || true

      mkdir -p "$VAULT_DIR/$LOG_SUBDIR"
      cat "$LOG_FILE" >> "$TARGET_FILE"

      git add "$LOG_SUBDIR/"
      if git diff --cached --quiet; then
        exit 0
      fi

      git commit -m "$COMMIT_PREFIX Flush event log" --quiet
      git push origin main --quiet

      # Truncate local log on success
      : > "$LOG_FILE"

  # Awaiting secrets marker
  - path: /etc/lobmob/.awaiting-secrets
    content: "Secrets not yet provisioned. Run: lobmob deploy\n"

runcmd:
  # Install GitHub CLI (auth happens later via provision script)
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
  - echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update && apt-get install -y gh

  # Install doctl (auth happens later via provision script)
  - snap install doctl

  # Install Node.js 22
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install OpenClaw (config written later via provision script)
  - npm install -g openclaw@latest
  - mkdir -p /root/.openclaw/skills

  # Git identity only -- no auth
  - git config --global user.name "lobboss"
  - git config --global user.email "lobboss@lobmob.swarm"

  # Pool manager cron -- every 5 minutes
  - echo "*/5 * * * * root /usr/local/bin/lobmob-pool-manager >> /var/log/lobmob-pool-manager.log 2>&1" >> /etc/crontab

  # PR review cron -- every 2 minutes
  - echo "*/2 * * * * root /usr/local/bin/lobmob-review-prs >> /var/log/lobmob-pr-review.log 2>&1" >> /etc/crontab

  # Event log flush cron -- every 15 minutes
  - echo "*/15 * * * * root /usr/local/bin/lobmob-flush-logs >> /var/log/lobmob-flush.log 2>&1" >> /etc/crontab

