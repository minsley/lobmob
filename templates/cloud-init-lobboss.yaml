#cloud-config
#
# Lobboss cloud-init -- CONTAINS NO SECRETS.
# Installs packages and writes config skeletons only.
# Scripts are deployed via SCP by `lobmob deploy`.
# Secrets are pushed via SSH after boot.

package_update: true
package_upgrade: true

packages:
  - wireguard
  - git
  - jq
  - curl
  - unzip

write_files:
  # WireGuard skeleton -- private key injected by provision script
  - path: /etc/wireguard/wg0.conf.template
    permissions: "0600"
    content: |
      [Interface]
      PrivateKey = __WG_PRIVATE_KEY__
      Address = ${wg_subnet}.1/24
      ListenPort = 51820
      SaveConfig = true

  # Non-secret config -- secrets + GH App config appended by provision script
  - path: /etc/lobmob/env
    permissions: "0600"
    content: |
      VAULT_REPO=${vault_repo}
      PROJECT_NAME=${project_name}
      LOBSTER_SIZE=${lobster_size}
      REGION=${region}
      SSH_KEY_ID=${ssh_key_id}
      VPC_UUID=${vpc_uuid}
      LOBSTER_TAG=${lobster_tag}
      POOL_ACTIVE=1
      POOL_STANDBY=2
      DISCORD_CHANNEL_TASK_QUEUE=${discord_channels.task_queue}
      DISCORD_CHANNEL_SWARM_CONTROL=${discord_channels.swarm_control}
      DISCORD_CHANNEL_SWARM_LOGS=${discord_channels.swarm_logs}

  # SSH config skeleton for GitHub
  - path: /root/.ssh/config
    permissions: "0644"
    content: |
      Host github.com
        IdentityFile /root/.ssh/vault_key
        StrictHostKeyChecking accept-new

  # Web UI systemd service
  - path: /etc/systemd/system/lobmob-web.service
    permissions: "0644"
    content: |
      [Unit]
      Description=lobmob Web UI
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/node /usr/local/bin/lobmob-web
      Restart=on-failure
      RestartSec=5
      StandardOutput=append:/var/log/lobmob-web.log
      StandardError=append:/var/log/lobmob-web.log

      [Install]
      WantedBy=multi-user.target

  # OpenClaw gateway systemd service
  - path: /etc/systemd/system/openclaw-gateway.service
    permissions: "0644"
    content: |
      [Unit]
      Description=OpenClaw Gateway
      After=network.target wg-quick@wg0.service
      Wants=wg-quick@wg0.service

      [Service]
      Type=simple
      WorkingDirectory=/opt/vault
      EnvironmentFile=/root/.openclaw/.env
      ExecStart=/usr/bin/env openclaw gateway --port 18789
      Restart=on-failure
      RestartSec=10
      StandardOutput=append:/var/log/openclaw-gateway.log
      StandardError=append:/var/log/openclaw-gateway.log

      [Install]
      WantedBy=multi-user.target

  # Awaiting secrets marker
  - path: /etc/lobmob/.awaiting-secrets
    content: "Secrets not yet provisioned. Run: lobmob deploy\n"

runcmd:
  # Install GitHub CLI
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
  - echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update && apt-get install -y gh

  # Install doctl
  - snap install doctl

  # Install Node.js 22
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install OpenClaw
  - npm install -g openclaw@latest
  - mkdir -p /root/.openclaw/skills

  # Git identity only -- no auth
  - git config --global user.name "lobboss"
  - git config --global user.email "lobboss@lobmob.swarm"

  # Systemd reload for services written above
  - systemctl daemon-reload

  # Create directories
  - mkdir -p /etc/lobmob /var/lib/lobmob/task-state

  # Cron jobs (scripts are SCP'd by `lobmob deploy`, crons set up here)
  # Pool manager -- every 5 minutes
  - echo "*/5 * * * * root /usr/local/bin/lobmob-pool-manager >> /var/log/lobmob-pool-manager.log 2>&1" >> /etc/crontab
  # PR review -- every 2 minutes
  - echo "*/2 * * * * root /usr/local/bin/lobmob-review-prs >> /var/log/lobmob-pr-review.log 2>&1" >> /etc/crontab
  # Event log flush -- every 15 minutes
  - echo "*/15 * * * * root /usr/local/bin/lobmob-flush-logs >> /var/log/lobmob-flush.log 2>&1" >> /etc/crontab
  # GitHub auth refresh -- every 45 minutes
  - echo "*/45 * * * * root /usr/local/bin/lobmob-refresh-gh-auth >> /var/log/lobmob-gh-refresh.log 2>&1" >> /etc/crontab
  # TLS cert renewal -- every 4 days
  - echo "0 3 */4 * * root /usr/local/bin/lobmob-cert >> /var/log/lobmob-cert.log 2>&1" >> /etc/crontab
  # Task status watcher -- every 2 minutes
  - echo "*/2 * * * * root /usr/local/bin/lobmob-task-watcher >> /var/log/lobmob-task-watcher.log 2>&1" >> /etc/crontab
  # Weekly snapshot (Sunday 4am)
  - echo "0 4 * * 0 root /usr/local/bin/lobmob-snapshot >> /var/log/lobmob-snapshot.log 2>&1" >> /etc/crontab
  # Task manager -- assignment, timeouts, orphans (every 5 min)
  - echo "*/5 * * * * root /usr/local/bin/lobmob-task-manager >> /var/log/lobmob-task-manager.log 2>&1" >> /etc/crontab
  # Watchdog -- fleet health monitoring (every 5 min, replaces Haiku agent)
  - echo "*/5 * * * * root /usr/local/bin/lobmob-watchdog >> /var/log/lobmob-watchdog.log 2>&1" >> /etc/crontab
  # Status reporter -- fleet summary to #swarm-logs (every 30 min)
  - echo "*/30 * * * * root /usr/local/bin/lobmob-status-reporter >> /var/log/lobmob-status-reporter.log 2>&1" >> /etc/crontab
