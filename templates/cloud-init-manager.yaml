#cloud-config
#
# Manager cloud-init — CONTAINS NO SECRETS.
# Installs packages, scripts, and config skeletons.
# Secrets are pushed via SSH after boot by `lobmob deploy`.

package_update: true
package_upgrade: true

packages:
  - wireguard
  - git
  - jq
  - curl
  - unzip

write_files:
  # WireGuard skeleton — private key injected by provision script
  - path: /etc/wireguard/wg0.conf.template
    permissions: "0600"
    content: |
      [Interface]
      PrivateKey = __WG_PRIVATE_KEY__
      Address = 10.0.0.1/24
      ListenPort = 51820
      SaveConfig = true

  # Non-secret config only — secrets appended by provision script
  - path: /etc/lobmob/env
    permissions: "0600"
    content: |
      VAULT_REPO=${vault_repo}
      PROJECT_NAME=${project_name}
      WORKER_SIZE=${worker_size}
      REGION=${region}
      SSH_KEY_ID=${ssh_key_id}
      VPC_UUID=${vpc_uuid}
      WORKER_TAG=${worker_tag}

  # SSH config skeleton for GitHub — deploy key pushed by provision script
  - path: /root/.ssh/config
    permissions: "0644"
    content: |
      Host github.com
        IdentityFile /root/.ssh/vault_key
        StrictHostKeyChecking accept-new

  # Provision script — called by `lobmob deploy` via SSH after secrets are pushed
  - path: /usr/local/bin/lobmob-provision
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail

      echo "=== lobmob provision: configuring manager ==="

      # Validate secrets exist
      source /etc/lobmob/secrets.env 2>/dev/null || { echo "ERROR: /etc/lobmob/secrets.env not found"; exit 1; }
      for VAR in DO_TOKEN GH_TOKEN DISCORD_BOT_TOKEN ANTHROPIC_API_KEY; do
        if [ -z "${!VAR:-}" ]; then
          echo "ERROR: $VAR not set in secrets.env"
          exit 1
        fi
      done

      # Validate deploy key
      if [ ! -f /root/.ssh/vault_key ]; then
        echo "ERROR: /root/.ssh/vault_key not found"
        exit 1
      fi
      chmod 600 /root/.ssh/vault_key

      # Activate WireGuard
      if [ -f /etc/wireguard/wg0.conf ]; then
        wg-quick up wg0 2>/dev/null || true
        systemctl enable wg-quick@wg0
        echo "WireGuard: active"
      else
        echo "ERROR: /etc/wireguard/wg0.conf not found — was WG private key pushed?"
        exit 1
      fi

      # Authenticate GitHub CLI
      echo "$GH_TOKEN" | gh auth login --with-token
      gh auth setup-git
      echo "GitHub CLI: authenticated"

      # Git config
      git config --global user.name "lobmob-manager"
      git config --global user.email "manager@lobmob.swarm"

      # Authenticate doctl
      doctl auth init -t "$DO_TOKEN"
      echo "doctl: authenticated"

      # Clone vault repo
      source /etc/lobmob/env
      if [ ! -d /opt/vault/.git ]; then
        gh repo clone "$VAULT_REPO" /opt/vault
        cd /opt/vault && git checkout main
        echo "Vault: cloned"
      else
        cd /opt/vault && git pull origin main
        echo "Vault: updated"
      fi

      # Configure OpenClaw
      mkdir -p /root/.openclaw/skills
      cat > /root/.openclaw/config.json <<OCEOF
      {
        "defaultModel": "anthropic:claude-sonnet-4-5-20250929",
        "anthropicApiKey": "$ANTHROPIC_API_KEY",
        "channels": {
          "discord": {
            "enabled": true,
            "token": "$DISCORD_BOT_TOKEN"
          }
        }
      }
      OCEOF
      chmod 600 /root/.openclaw/config.json

      # Copy manager skills
      cp -r /opt/vault/040-fleet/manager-skills/* /root/.openclaw/skills/ 2>/dev/null || true

      # Remove provision marker
      rm -f /etc/lobmob/.awaiting-secrets

      echo "=== lobmob provision: complete ==="

  # Worker spawn script — creates droplets with SECRET-FREE cloud-init,
  # then pushes secrets via SSH over WireGuard after boot
  - path: /usr/local/bin/lobmob-spawn-worker
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env

      WORKER_ID="$${1:-$(openssl rand -hex 4)}"
      WG_IP="$${2:-}"

      if [ -z "$WG_IP" ]; then
        EXISTING=$(wg show wg0 allowed-ips 2>/dev/null | awk '{print $2}' | cut -d/ -f1 | sort -t. -k4 -n | tail -1)
        LAST_OCTET=$(echo "$${EXISTING:-10.0.0.1}" | cut -d. -f4)
        NEXT_OCTET=$((LAST_OCTET + 1))
        WG_IP="10.0.0.$${NEXT_OCTET}"
      fi

      # Generate WireGuard keypair for worker
      WORKER_WG_PRIVKEY=$(wg genkey)
      WORKER_WG_PUBKEY=$(echo "$WORKER_WG_PRIVKEY" | wg pubkey)
      MANAGER_PUB_IP=$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)
      MANAGER_WG_PUBKEY=$(wg show wg0 public-key)

      # Build SECRET-FREE cloud-init for worker
      # Only contains: packages, WireGuard config (ephemeral key — not a stored secret),
      # SSH authorized keys, git identity, Node.js, OpenClaw, gh CLI install
      WORKER_USERDATA=$(cat <<USERDATA
      #!/bin/bash
      set -euo pipefail

      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get install -y wireguard git jq curl unzip

      # WireGuard — uses ephemeral keypair generated by manager at spawn time
      cat > /etc/wireguard/wg0.conf <<WGEOF
      [Interface]
      PrivateKey = $WORKER_WG_PRIVKEY
      Address = $WG_IP/24
      ListenPort = 51820

      [Peer]
      PublicKey = $MANAGER_WG_PUBKEY
      AllowedIPs = 10.0.0.0/24
      Endpoint = $MANAGER_PUB_IP:51820
      PersistentKeepalive = 25
      WGEOF

      wg-quick up wg0
      systemctl enable wg-quick@wg0

      # SSH authorized key from DO metadata
      mkdir -p /root/.ssh
      curl -s http://169.254.169.254/metadata/v1/public-keys >> /root/.ssh/authorized_keys

      # Git identity only — no auth tokens
      git config --global user.name "worker-$WORKER_ID"
      git config --global user.email "worker-$WORKER_ID@lobmob.swarm"

      # Install GitHub CLI (auth happens via manager SSH push)
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
      echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        > /etc/apt/sources.list.d/github-cli.list
      apt-get update && apt-get install -y gh

      # Node.js 22
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs

      # OpenClaw (config written later by manager via SSH)
      npm install -g openclaw@latest
      mkdir -p /root/.openclaw/skills /etc/lobmob

      # Non-secret config
      cat > /etc/lobmob/env <<ENVEOF
      WORKER_ID=$WORKER_ID
      WG_IP=$WG_IP
      ENVEOF

      # Signal that cloud-init is done, awaiting secrets
      touch /etc/lobmob/.cloud-init-done
      touch /etc/lobmob/.awaiting-secrets

      USERDATA
      )

      # Create the droplet
      RESPONSE=$(doctl compute droplet create \
        "lobmob-worker-$WORKER_ID" \
        --region "$REGION" \
        --size "$WORKER_SIZE" \
        --image ubuntu-24-04-x64 \
        --ssh-keys "$SSH_KEY_ID" \
        --vpc-uuid "$VPC_UUID" \
        --tag-name "$WORKER_TAG" \
        --user-data "$WORKER_USERDATA" \
        --wait \
        --format ID,PublicIPv4 \
        --no-header \
        --output json)

      DROPLET_ID=$(echo "$RESPONSE" | jq -r '.[0].id')
      DROPLET_IP=$(echo "$RESPONSE" | jq -r '.[0].networks.v4[] | select(.type=="public") | .ip_address')

      # Add worker as WireGuard peer on manager
      wg set wg0 peer "$WORKER_WG_PUBKEY" allowed-ips "$WG_IP/32" endpoint "$DROPLET_IP:51820"

      echo "Droplet created. Waiting for WireGuard connectivity..."
      for i in $(seq 1 30); do
        if ping -c 1 -W 2 "$WG_IP" > /dev/null 2>&1; then
          echo "WireGuard: connected to $WG_IP"
          break
        fi
        sleep 5
      done

      # Wait for cloud-init to finish
      echo "Waiting for cloud-init to complete on worker..."
      for i in $(seq 1 60); do
        if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "root@$WG_IP" \
          "test -f /etc/lobmob/.cloud-init-done" 2>/dev/null; then
          echo "Cloud-init: done"
          break
        fi
        sleep 10
      done

      # Push secrets to worker via SSH over WireGuard
      echo "Pushing secrets to worker via SSH..."

      # Write secrets.env
      ssh "root@$WG_IP" "cat > /etc/lobmob/secrets.env && chmod 600 /etc/lobmob/secrets.env" <<SECRETS
      GH_TOKEN=$GH_TOKEN
      DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
      ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY
      SECRETS

      # Authenticate gh and clone vault
      ssh "root@$WG_IP" bash <<PROVISION
      set -euo pipefail
      source /etc/lobmob/secrets.env

      # GitHub auth
      echo "\$GH_TOKEN" | gh auth login --with-token
      gh auth setup-git

      # Clone vault
      source /etc/lobmob/env
      gh repo clone "$VAULT_REPO" /opt/vault 2>/dev/null || (cd /opt/vault && git pull origin main)
      cd /opt/vault && git checkout main

      # OpenClaw config
      cat > /root/.openclaw/config.json <<OCEOF
      {
        "defaultModel": "anthropic:claude-sonnet-4-5-20250929",
        "anthropicApiKey": "\$ANTHROPIC_API_KEY",
        "channels": {
          "discord": {
            "enabled": true,
            "token": "\$DISCORD_BOT_TOKEN"
          }
        }
      }
      OCEOF
      chmod 600 /root/.openclaw/config.json

      # Copy worker skills
      cp -r /opt/vault/040-fleet/worker-skills/* /root/.openclaw/skills/ 2>/dev/null || true

      # Write worker AGENTS.md
      cat > /root/.openclaw/AGENTS.md <<AGENTEOF
      ---
      name: worker-$WORKER_ID
      model: anthropic:claude-sonnet-4-5-20250929
      ---
      You are worker-$WORKER_ID in the lobmob swarm. Your WireGuard IP is $WG_IP.
      You execute tasks assigned by the manager agent via Discord #swarm-control.
      When you complete a task:
      1. Write results to the vault repo under /opt/vault/
      2. Create a PR using the submit-results skill
      3. Post a summary with PR link to #results
      Report failures honestly. Self-destruct when idle too long.
      AGENTEOF

      # Mark secrets provisioned
      rm -f /etc/lobmob/.awaiting-secrets
      echo "WORKER_READY"
      PROVISION

      echo "Worker provisioned."

      # Output worker info as JSON
      cat <<EOF
      {
        "worker_id": "worker-$WORKER_ID",
        "droplet_id": "$DROPLET_ID",
        "public_ip": "$DROPLET_IP",
        "wireguard_ip": "$WG_IP",
        "wg_public_key": "$WORKER_WG_PUBKEY"
      }
      EOF

  # Worker teardown script
  - path: /usr/local/bin/lobmob-teardown-worker
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env

      WORKER_NAME="$1"

      # Get droplet ID
      DROPLET_ID=$(doctl compute droplet list \
        --tag-name "$WORKER_TAG" \
        --format ID,Name \
        --no-header | grep "$WORKER_NAME" | awk '{print $1}')

      if [ -z "$DROPLET_ID" ]; then
        echo "Worker $WORKER_NAME not found"
        exit 1
      fi

      # Remove WireGuard peer
      WG_PUBKEY=$(grep "$WORKER_NAME" /opt/vault/040-fleet/registry.md 2>/dev/null \
        | grep -oP 'wg_pubkey: \K\S+' || true)
      if [ -n "$WG_PUBKEY" ]; then
        wg set wg0 peer "$WG_PUBKEY" remove
      fi

      # Destroy droplet
      doctl compute droplet delete "$DROPLET_ID" --force

      echo "Destroyed $WORKER_NAME (droplet $DROPLET_ID)"

  # Fleet status script
  - path: /usr/local/bin/lobmob-fleet-status
    permissions: "0755"
    content: |
      #!/bin/bash
      source /etc/lobmob/env

      echo "=== WireGuard Peers ==="
      wg show wg0

      echo ""
      echo "=== Active Worker Droplets ==="
      doctl compute droplet list --tag-name "$WORKER_TAG" --format ID,Name,PublicIPv4,Status,Created --no-header

      echo ""
      echo "=== Open PRs ==="
      cd /opt/vault && gh pr list --state open --json number,title,headRefName,author,createdAt 2>/dev/null || echo "No vault repo"

  # Stale worker cleanup cron
  - path: /usr/local/bin/lobmob-cleanup
    permissions: "0755"
    content: |
      #!/bin/bash
      source /etc/lobmob/env
      source /etc/lobmob/secrets.env 2>/dev/null || true

      MAX_AGE_HOURS="${1:-2}"
      NOW=$(date +%s)

      doctl compute droplet list --tag-name "$WORKER_TAG" --format ID,Name,Created --no-header | while read -r ID NAME CREATED; do
        CREATED_TS=$(date -d "$CREATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$CREATED" +%s 2>/dev/null)
        AGE_HOURS=$(( (NOW - CREATED_TS) / 3600 ))
        if [ "$AGE_HOURS" -ge "$MAX_AGE_HOURS" ]; then
          echo "Destroying stale worker $NAME (age: ${AGE_HOURS}h)"
          lobmob-teardown-worker "$NAME"
        fi
      done

  # PR review script
  - path: /usr/local/bin/lobmob-review-prs
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      source /etc/lobmob/env
      cd /opt/vault

      git checkout main && git pull origin main

      PRS=$(gh pr list --state open --json number,title,headRefName --jq '.[]' 2>/dev/null)
      if [ -z "$PRS" ]; then
        exit 0
      fi

      echo "$PRS" | jq -c '.' | while read -r PR; do
        NUMBER=$(echo "$PR" | jq -r '.number')
        TITLE=$(echo "$PR" | jq -r '.title')
        BRANCH=$(echo "$PR" | jq -r '.headRefName')

        echo "Reviewing PR #$NUMBER: $TITLE ($BRANCH)"

        # Check diff for secrets
        DIFF=$(gh pr diff "$NUMBER" 2>/dev/null || true)
        if echo "$DIFF" | grep -qiE '(sk-ant-|dop_v1_|github_pat_|PRIVATE KEY)'; then
          gh pr comment "$NUMBER" --body "Possible secrets detected in diff. Please remove and force-push."
          echo "BLOCKED PR #$NUMBER — secrets detected"
          continue
        fi

        # Check file paths are within allowed directories
        FILES=$(gh pr view "$NUMBER" --json files --jq '.files[].path')
        INVALID=$(echo "$FILES" | grep -vE '^(010-tasks/|020-logs/|030-knowledge/|000-inbox/)' || true)
        if [ -n "$INVALID" ]; then
          gh pr comment "$NUMBER" --body "Files outside allowed paths: $INVALID"
          echo "BLOCKED PR #$NUMBER — invalid paths"
          continue
        fi

        echo "PR #$NUMBER passes checks — ready for manager agent review"
      done

  # Awaiting secrets marker
  - path: /etc/lobmob/.awaiting-secrets
    content: "Secrets not yet provisioned. Run: lobmob deploy\n"

runcmd:
  # Install GitHub CLI (auth happens later via provision script)
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
  - echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update && apt-get install -y gh

  # Install doctl (auth happens later via provision script)
  - curl -sL https://github.com/digitalocean/doctl/releases/latest/download/doctl-1.104.0-linux-amd64.tar.gz | tar -xzv -C /usr/local/bin

  # Install Node.js 22
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs

  # Install OpenClaw (config written later via provision script)
  - npm install -g openclaw@latest
  - mkdir -p /root/.openclaw/skills

  # Git identity only — no auth
  - git config --global user.name "lobmob-manager"
  - git config --global user.email "manager@lobmob.swarm"

  # Cleanup cron — every 30 minutes
  - echo "*/30 * * * * root /usr/local/bin/lobmob-cleanup 2" >> /etc/crontab

  # PR review cron — every 2 minutes
  - echo "*/2 * * * * root /usr/local/bin/lobmob-review-prs >> /var/log/lobmob-pr-review.log 2>&1" >> /etc/crontab

  # Signal cloud-init complete
  - touch /etc/lobmob/.cloud-init-done
